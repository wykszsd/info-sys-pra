import{a5 as ge,a6 as fe,r as j,a7 as je,bQ as ye,aR as be,ag as ve,ba as Ce,a_ as Ie,j as e,a8 as G,a9 as we,aa as Se,bR as X,ad as Te,e as Q,R as Y,T as a,P as se,I as De,f as Re,h as F,B as E,d as z,C as ie,u as ke,c as Ee,ar as Z,bS as ze,bT as We,bU as $e}from"./index-CKLgkD1v.js";import{R as Ae}from"./Refresh-BWjUhbNv.js";import{I as q}from"./InfoOutlined-CEViPEnt.js";import{S as Me,E as He}from"./EventAvailable-D8fnVWep.js";import{T as Pe,a as Le,b as Be,c as N,d as Oe}from"./TableRow-DM6qFwiW.js";import{T as c}from"./TableCell-BtnOls6d.js";import{C as ee}from"./Chip-DfvBT8qY.js";import{G as b}from"./Grid-CW7wBfPk.js";import{D as _e,a as Fe,b as Ne}from"./DialogContent-DRqBLQZ-.js";import{D as Ue}from"./DialogTitle-CHEgnswe.js";import{T as Ve}from"./TextField-CAILEkKj.js";import{T as Ge,a as U}from"./Tabs-Cdd7RlJK.js";import{A as te}from"./Alert-DDDj34Iz.js";import{S as Qe}from"./Snackbar-HS5EKS66.js";import"./Select-JmEIo2-X.js";import"./KeyboardArrowRight-BSJIH089.js";function Je(n){return ge("MuiCollapse",n)}fe("MuiCollapse",["root","horizontal","vertical","entered","hidden","wrapper","wrapperInner"]);const Ke=n=>{const{orientation:s,classes:o}=n,y={root:["root",`${s}`],entered:["entered"],hidden:["hidden"],wrapper:["wrapper",`${s}`],wrapperInner:["wrapperInner",`${s}`]};return Se(y,Je,o)},Xe=G("div",{name:"MuiCollapse",slot:"Root",overridesResolver:(n,s)=>{const{ownerState:o}=n;return[s.root,s[o.orientation],o.state==="entered"&&s.entered,o.state==="exited"&&!o.in&&o.collapsedSize==="0px"&&s.hidden]}})(Te(({theme:n})=>({height:0,overflow:"hidden",transition:n.transitions.create("height"),variants:[{props:{orientation:"horizontal"},style:{height:"auto",width:0,transition:n.transitions.create("width")}},{props:{state:"entered"},style:{height:"auto",overflow:"visible"}},{props:{state:"entered",orientation:"horizontal"},style:{width:"auto"}},{props:({ownerState:s})=>s.state==="exited"&&!s.in&&s.collapsedSize==="0px",style:{visibility:"hidden"}}]}))),Ye=G("div",{name:"MuiCollapse",slot:"Wrapper"})({display:"flex",width:"100%",variants:[{props:{orientation:"horizontal"},style:{width:"auto",height:"100%"}}]}),Ze=G("div",{name:"MuiCollapse",slot:"WrapperInner"})({width:"100%",variants:[{props:{orientation:"horizontal"},style:{width:"auto",height:"100%"}}]}),V=j.forwardRef(function(s,o){const y=je({props:s,name:"MuiCollapse"}),{addEndListener:l,children:p,className:v,collapsedSize:d="0px",component:h,easing:t,in:u,onEnter:x,onEntered:C,onEntering:W,onExit:$,onExited:B,onExiting:A,orientation:S="vertical",style:r,timeout:m=ye.standard,TransitionComponent:oe=be,...ae}=y,M={...y,orientation:S,collapsedSize:d},T=Ke(M),J=ve(),re=Ce(),I=j.useRef(null),O=j.useRef(),H=typeof d=="number"?`${d}px`:d,D=S==="horizontal",R=D?"width":"height",P=j.useRef(null),le=Ie(o,P),w=i=>g=>{if(i){const f=P.current;g===void 0?i(f):i(f,g)}},_=()=>I.current?I.current[D?"clientWidth":"clientHeight"]:0,ce=w((i,g)=>{I.current&&D&&(I.current.style.position="absolute"),i.style[R]=H,x&&x(i,g)}),de=w((i,g)=>{const f=_();I.current&&D&&(I.current.style.position="");const{duration:k,easing:L}=X({style:r,timeout:m,easing:t},{mode:"enter"});if(m==="auto"){const K=J.transitions.getAutoHeightDuration(f);i.style.transitionDuration=`${K}ms`,O.current=K}else i.style.transitionDuration=typeof k=="string"?k:`${k}ms`;i.style[R]=`${f}px`,i.style.transitionTimingFunction=L,W&&W(i,g)}),pe=w((i,g)=>{i.style[R]="auto",C&&C(i,g)}),he=w(i=>{i.style[R]=`${_()}px`,$&&$(i)}),ue=w(B),xe=w(i=>{const g=_(),{duration:f,easing:k}=X({style:r,timeout:m,easing:t},{mode:"exit"});if(m==="auto"){const L=J.transitions.getAutoHeightDuration(g);i.style.transitionDuration=`${L}ms`,O.current=L}else i.style.transitionDuration=typeof f=="string"?f:`${f}ms`;i.style[R]=H,i.style.transitionTimingFunction=k,A&&A(i)}),me=i=>{m==="auto"&&re.start(O.current||0,i),l&&l(P.current,i)};return e.jsx(oe,{in:u,onEnter:ce,onEntered:pe,onEntering:de,onExit:he,onExited:ue,onExiting:xe,addEndListener:me,nodeRef:P,timeout:m==="auto"?null:m,...ae,children:(i,{ownerState:g,...f})=>e.jsx(Xe,{as:h,className:we(T.root,v,{entered:T.entered,exited:!u&&H==="0px"&&T.hidden}[i]),style:{[D?"minWidth":"minHeight"]:H,...r},ref:le,ownerState:{...M,state:i},...f,children:e.jsx(Ye,{ownerState:{...M,state:i},className:T.wrapper,ref:I,children:e.jsx(Ze,{ownerState:{...M,state:i},className:T.wrapperInner,children:p})})})})});V&&(V.muiSupportAuto=!0);const qe=Q(e.jsx("path",{d:"M21 8h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2c0-1.1-.9-2-2-2m0 4-3 7H9V9l4.34-4.34L12.23 10H21zM1 9h4v12H1z"})),et=Q(e.jsx("path",{d:"M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.58-6.59c.37-.36.59-.86.59-1.41V5c0-1.1-.9-2-2-2m0 12-4.34 4.34L11.77 14H3v-2l3-7h9zm4-12h4v12h-4z"})),tt=Q(e.jsx("path",{d:"M12 5.9c1.16 0 2.1.94 2.1 2.1s-.94 2.1-2.1 2.1S9.9 9.16 9.9 8s.94-2.1 2.1-2.1m0 9c2.97 0 6.1 1.46 6.1 2.1v1.1H5.9V17c0-.64 3.13-2.1 6.1-2.1M12 4C9.79 4 8 5.79 8 8s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4m0 9c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4"})),nt=n=>n==="schedule_change"?"调课申请":n==="exam_arrangement"?"考试安排申请":"未知类型",ne=n=>{if(n.originalScheduleInfo&&n.originalScheduleInfo.trim()!=="")return n.originalScheduleInfo;const s=[],o=["一","二","三","四","五","六","日"];return n.courseName?s.push(n.courseName):n.originalScheduleId&&s.push(`课程ID ${n.originalScheduleId}`),n.originalWeekDay&&n.originalSectionId?s.push(`周${o[n.originalWeekDay-1]} 第${n.originalSectionId}节`):n.originalSectionId?s.push(`第${n.originalSectionId}节`):n.originalWeekDay&&s.push(`周${o[n.originalWeekDay-1]}`),n.originalClassroomInfo?s.push(`@ ${n.originalClassroomInfo}`):n.originalClassroomId&&s.push(`@ 教室ID ${n.originalClassroomId}`),n.originalWeeks&&s.push(`[${n.originalWeeks}]`),s.length===0&&n.originalScheduleId?`原课程ID: ${n.originalScheduleId} (详情不足)`:s.length>0?s.join(" "):"原安排信息不详"},st=({requests:n,onApprove:s,onReject:o,isProcessingAction:y})=>{const[l,p]=Y.useState(null),v=t=>{p(l===t?null:t)};if(!n||n.length===0)return e.jsx(a,{sx:{mt:3,textAlign:"center",color:"text.secondary"},children:"太棒了！当前没有待审批的请求。"});const d=t=>e.jsxs(b,{container:!0,spacing:1,sx:{p:1,backgroundColor:"grey.50",borderRadius:1},children:[e.jsxs(b,{size:{xs:12,sm:6},children:[" ",e.jsx(a,{variant:"caption",display:"block",fontWeight:"bold",children:"原安排:"}),e.jsxs(a,{variant:"caption",display:"block",children:[ne(t)," "]})]}),e.jsxs(b,{size:{xs:12,sm:6},children:[" ",e.jsx(a,{variant:"caption",display:"block",fontWeight:"bold",color:"primary.main",children:"新安排:"}),e.jsxs(a,{variant:"caption",display:"block",children:["周",t.proposedWeekDay?["一","二","三","四","五","六","日"][t.proposedWeekDay-1]:"?",` 第${t.proposedSectionId||"?"}节 `]}),e.jsxs(a,{variant:"caption",display:"block",children:["教室: ",t.proposedClassroomInfo||(t.proposedClassroomId?`ID ${t.proposedClassroomId}`:"?")]}),e.jsxs(a,{variant:"caption",display:"block",children:["周次: ",t.proposedWeeks||"?"]})]}),e.jsxs(b,{size:{xs:12},children:[" ",e.jsx(a,{variant:"caption",display:"block",fontWeight:"bold",children:"调课原因:"}),e.jsx(a,{variant:"caption",display:"block",sx:{whiteSpace:"pre-wrap"},children:t.reason})]})]}),h=t=>e.jsxs(b,{container:!0,spacing:1,sx:{p:1,backgroundColor:"grey.50",borderRadius:1},children:[e.jsxs(b,{size:{xs:12,sm:6},children:[" ",e.jsx(a,{variant:"caption",display:"block",fontWeight:"bold",children:"考试类型:"}),e.jsx(a,{variant:"caption",display:"block",children:t.examType==="final"?"期末":t.examType==="midterm"?"期中":t.examType||"补考"})]}),e.jsxs(b,{size:{xs:12,sm:6},children:[" ",e.jsx(a,{variant:"caption",display:"block",fontWeight:"bold",children:"建议日期:"}),e.jsx(a,{variant:"caption",display:"block",children:F(t.proposedDate||"","yyyy-MM-dd")})]}),e.jsxs(b,{size:{xs:12,sm:6},children:[" ",e.jsx(a,{variant:"caption",display:"block",fontWeight:"bold",color:"primary.main",children:"建议安排:"}),e.jsx(a,{variant:"caption",display:"block",children:`第${t.proposedSectionId||"?"}节, 时长: ${t.proposedDuration||"?"}分钟`}),e.jsxs(a,{variant:"caption",display:"block",children:["考场: ",t.proposedClassroomInfo||(t.proposedClassroomId?`ID ${t.proposedClassroomId}`:"?")]})]}),e.jsxs(b,{size:{xs:12},children:[" ",e.jsx(a,{variant:"caption",display:"block",fontWeight:"bold",children:"申请原因/备注:"}),e.jsx(a,{variant:"caption",display:"block",sx:{whiteSpace:"pre-wrap"},children:t.examReason||t.reason})]})]});return e.jsx(Pe,{component:se,elevation:2,sx:{mt:2},children:e.jsxs(Le,{sx:{minWidth:950},"aria-label":"待审批请求列表",children:[e.jsx(Be,{sx:{backgroundColor:"grey.100"},children:e.jsxs(N,{children:[e.jsx(c,{sx:{width:"5%"},children:null}),e.jsx(c,{sx:{fontWeight:"bold",width:"10%"},children:"类型"}),e.jsx(c,{sx:{fontWeight:"bold",width:"15%"},children:"申请人"}),e.jsx(c,{sx:{fontWeight:"bold",width:"20%"},children:"申请课程"}),e.jsx(c,{sx:{fontWeight:"bold",width:"25%"},children:"核心信息"}),e.jsx(c,{sx:{fontWeight:"bold",width:"15%"},children:"申请时间"}),e.jsx(c,{align:"center",sx:{fontWeight:"bold",width:"15%"},children:"操作"})]})}),e.jsx(Oe,{children:n.map(t=>{const u=y(t.requestId),x=l===t.requestId;return e.jsxs(Y.Fragment,{children:[e.jsxs(N,{hover:!0,sx:{"& > *":{borderBottom:"unset"},opacity:u?.6:1,cursor:"pointer"},onClick:()=>v(t.requestId),children:[e.jsx(c,{children:e.jsx(De,{"aria-label":"expand row",size:"small",children:x?e.jsx(q,{color:"action"}):e.jsx(q,{color:"disabled"})})}),e.jsx(c,{children:e.jsx(Re,{title:nt(t.requestType),children:e.jsx(ee,{icon:t.requestType==="schedule_change"?e.jsx(Me,{}):e.jsx(He,{}),label:t.requestType==="schedule_change"?"调课":"考试",size:"small",color:t.requestType==="schedule_change"?"info":"secondary"})})}),e.jsx(c,{children:e.jsx(ee,{icon:e.jsx(tt,{}),label:t.teacherName||t.teacherId||"未知教师",size:"small",variant:"outlined"})}),e.jsx(c,{children:t.courseName||`(课程ID: ${t.courseId||t.originalScheduleId})`}),e.jsx(c,{children:t.requestType==="schedule_change"?`原: ${ne(t).substring(0,15)}... 新: 周${t.proposedWeekDay?["一","二","三","四","五","六","日"][t.proposedWeekDay-1]:"?"} 第${t.proposedSectionId||"?"}节...`:`类型: ${t.examType||"?"}, 日期: ${F(t.proposedDate||"","MM-dd")}, 第${t.proposedSectionId||"?"}节...`}),e.jsx(c,{children:F(t.requestedAt,"yyyy-MM-dd HH:mm")}),e.jsx(c,{align:"center",children:e.jsxs(E,{sx:{display:"flex",gap:1,justifyContent:"center"},children:[e.jsx(z,{variant:"contained",size:"small",color:"success",startIcon:e.jsx(qe,{}),onClick:C=>{C.stopPropagation(),s(t.requestId)},disabled:u,children:"批准"}),e.jsx(z,{variant:"contained",size:"small",color:"error",startIcon:e.jsx(et,{}),onClick:C=>{C.stopPropagation(),o(t.requestId)},disabled:u,children:"拒绝"})]})})]}),e.jsx(N,{children:e.jsx(c,{style:{paddingBottom:0,paddingTop:0},colSpan:7,children:e.jsx(V,{in:x,timeout:"auto",unmountOnExit:!0,children:e.jsxs(E,{sx:{margin:1,p:2,border:"1px solid #eee",borderRadius:1,backgroundColor:"rgb(245, 245, 245, 0.5)"},children:[e.jsxs(a,{variant:"h6",gutterBottom:!0,component:"div",fontSize:"1rem",fontWeight:"medium",children:["申请详情 (ID: ",t.requestId,")"]}),t.requestType==="schedule_change"?d(t):h(t)]})})})})]},t.requestId)})})]})})},it=({open:n,onClose:s,onSubmit:o,title:y="拒绝申请",isSubmitting:l=!1})=>{const[p,v]=j.useState(""),[d,h]=j.useState("");j.useEffect(()=>{n||(v(""),h(""))},[n]);const t=()=>{document.activeElement instanceof HTMLElement&&document.activeElement.blur(),s()},u=async()=>{if(p.trim().length<5){h("拒绝原因至少需要5个字符。");return}h(""),document.activeElement instanceof HTMLElement&&document.activeElement.blur(),await o(p.trim())};return e.jsxs(_e,{open:n,onClose:t,maxWidth:"xs",fullWidth:!0,children:[e.jsx(Ue,{children:y}),e.jsx(Fe,{children:e.jsx(Ve,{autoFocus:!0,margin:"dense",label:"拒绝原因 *",type:"text",fullWidth:!0,variant:"outlined",multiline:!0,rows:4,value:p,onChange:x=>{v(x.target.value),d&&h("")},required:!0,error:!!d,helperText:d||"请详细填写拒绝该申请的原因。",disabled:l})}),e.jsxs(Ne,{sx:{px:3,pb:2},children:[e.jsx(z,{onClick:t,disabled:l,color:"inherit",children:"取消"}),e.jsx(z,{onClick:u,variant:"contained",color:"error",disabled:l||!p.trim(),startIcon:l?e.jsx(ie,{size:20,color:"inherit"}):null,children:"确认拒绝"})]})]})},vt=()=>{const n=ke(),{pendingRequests:s,isLoading:o,isProcessing:y,error:l,filterType:p}=Ee(r=>r.adminRequests),[v,d]=j.useState(!1),[h,t]=j.useState(null),[u,x]=j.useState({open:!1,message:"",severity:"info"});j.useEffect(()=>{n(Z({filterType:p}))},[n,p]);const C=async r=>{try{await n(We(r)).unwrap(),x({open:!0,message:`请求 #${r} 已成功批准。`,severity:"success"})}catch(m){x({open:!0,message:`批准请求 #${r} 失败: ${m||"未知错误"}`,severity:"error"})}},W=r=>{t(r),d(!0)},$=async r=>{if(h!==null)try{await n($e({requestId:h,reason:r})).unwrap(),x({open:!0,message:`请求 #${h} 已成功拒绝。`,severity:"success"})}catch(m){x({open:!0,message:`拒绝请求 #${h} 失败: ${m||"未知错误"}`,severity:"error"})}finally{d(!1),t(null)}},B=(r,m)=>{n(ze(m))},A=()=>{n(Z({filterType:p}))},S=()=>x({...u,open:!1});return e.jsxs(se,{sx:{p:{xs:2,sm:3},minHeight:"calc(100vh - 64px - 48px)"},children:[e.jsxs(E,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,flexWrap:"wrap",gap:2},children:[e.jsx(a,{variant:"h4",component:"h1",children:"请求审批中心"}),e.jsx(z,{variant:"outlined",startIcon:e.jsx(Ae,{}),onClick:A,disabled:o,children:"刷新列表"})]}),e.jsx(E,{sx:{borderBottom:1,borderColor:"divider",mb:2},children:e.jsxs(Ge,{value:p,onChange:B,indicatorColor:"primary",textColor:"primary",variant:"scrollable",scrollButtons:"auto",allowScrollButtonsMobile:!0,children:[e.jsx(U,{label:"全部待审批",value:"all"}),e.jsx(U,{label:"调课申请",value:"schedule_change"}),e.jsx(U,{label:"考试安排申请",value:"exam_arrangement"})]})}),o&&s.length===0&&e.jsxs(E,{sx:{display:"flex",justifyContent:"center",my:5},children:[e.jsx(ie,{})," ",e.jsx(a,{sx:{ml:2},children:"加载待审批请求..."})]}),l&&!o&&e.jsxs(te,{severity:"error",sx:{mt:2},children:["加载请求列表失败: ",l]}),!o&&!l&&e.jsx(st,{requests:s,onApprove:C,onReject:W,isProcessingAction:r=>y.has(r)}),!o&&!l&&s.length===0&&e.jsx(a,{sx:{mt:4,textAlign:"center",color:"text.secondary"},children:"当前没有待审批的请求。"}),e.jsx(it,{open:v,onClose:()=>{d(!1),t(null)},onSubmit:$,title:"输入拒绝原因"}),e.jsx(Qe,{open:u.open,autoHideDuration:5e3,onClose:S,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(te,{onClose:S,severity:u.severity,sx:{width:"100%"},variant:"filled",children:u.message})})]})};export{vt as default};
