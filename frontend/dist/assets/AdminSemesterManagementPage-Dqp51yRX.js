import{e as L,j as e,m as D,r as o,p as A,aD as q,M as G,d as S,C as ne,u as le,c as oe,aq as ie,P as de,B as W,T as ce,h as H,aE as me,aF as ue,aG as pe,aH as he,aI as xe,aJ as fe}from"./index-CKLgkD1v.js";import{A as ge,D as je,z as ye,C as De,E as Ce,a as Se}from"./ConfirmDialog-COXuYVOi.js";import{C as ve}from"./CheckCircleOutline-B9_rkMsl.js";import{u as Ie,C as z,s as be,z as C}from"./index-Bf-gyStQ.js";import{D as we,a as ze,b as Me}from"./DialogContent-DRqBLQZ-.js";import{D as Te}from"./DialogTitle-CHEgnswe.js";import{G as x}from"./Grid-CW7wBfPk.js";import{T as B,F as Ae}from"./TextField-CAILEkKj.js";import{D as R}from"./DatePicker-B2zoPjm4.js";import{F as Ne,I as Fe,S as ke}from"./Select-JmEIo2-X.js";import{A as E}from"./Alert-DDDj34Iz.js";import{S as Pe}from"./Snackbar-HS5EKS66.js";import{C as _}from"./Chip-DfvBT8qY.js";import"./index-BIM5zmIj.js";import"./toPropertyKey-BRA8pAMC.js";import"./typeof-QjJsDpFa.js";import"./FormControlLabel-Yt6LKP0L.js";import"./KeyboardArrowRight-BSJIH089.js";import"./TableCell-BtnOls6d.js";import"./InputAdornment-vymAwCB7.js";const Ee=L(e.jsx("path",{d:"M14.59 8 12 10.59 9.41 8 8 9.41 10.59 12 8 14.59 9.41 16 12 13.41 14.59 16 16 14.59 13.41 12 16 9.41zM12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8"})),Oe=L(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-3.5l6-4.5-6-4.5z"})),N=new Date().getFullYear(),Ye=C.object({semesterName:C.string().min(5,"学期名称至少5字符").max(50,"名称过长"),startDate:C.date({required_error:"请选择开始日期"}),endDate:C.date({required_error:"请选择结束日期"}),termType:C.enum(["spring","fall"],{required_error:"请选择学期类型"}),academicYear:C.string().regex(/^\d{4}-\d{4}$/,"学年格式如: 2023-2024")}).refine(n=>n.endDate>n.startDate,{message:"结束日期必须晚于开始日期",path:["endDate"]}),$e=({open:n,onClose:f,onSubmit:g,initialData:l,isSubmitting:i,apiError:v})=>{var h;const j=!!l,{control:c,handleSubmit:F,reset:p,formState:{errors:t},setError:d}=Ie({resolver:be(Ye),defaultValues:{semesterName:"",startDate:D(new Date),endDate:D(new Date),termType:"spring",academicYear:`${N}-${N+1}`}});o.useEffect(()=>{n&&p(j&&l?{semesterName:l.semesterName,startDate:l.startDate&&q(A(l.startDate))?A(l.startDate):D(new Date),endDate:l.endDate&&q(A(l.endDate))?A(l.endDate):D(new Date),termType:l.termType,academicYear:l.academicYear}:{semesterName:"",startDate:D(new Date),endDate:D(new Date(new Date().setMonth(new Date().getMonth()+4))),termType:"spring",academicYear:`${N}-${N+1}`})},[l,n,p,j]),o.useEffect(()=>{v&&d("semesterName",{type:"manual",message:v})},[v,d]);const k=async r=>{const a={...r,startDate:r.startDate.toISOString().split("T")[0],endDate:r.endDate.toISOString().split("T")[0]};await g(a)};return e.jsxs(we,{open:n,onClose:f,maxWidth:"sm",fullWidth:!0,PaperProps:{component:"form",onSubmit:F(k)},children:[e.jsx(Te,{children:j?"编辑学期":"新增学期"}),e.jsx(ze,{children:e.jsxs(x,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(x,{size:12,children:e.jsx(z,{name:"semesterName",control:c,render:({field:r})=>{var a;return e.jsx(B,{...r,label:"学期名称",fullWidth:!0,required:!0,error:!!t.semesterName,helperText:(a=t.semesterName)==null?void 0:a.message,disabled:i})}})}),e.jsx(x,{size:{xs:12,sm:6},children:e.jsx(z,{name:"startDate",control:c,render:({field:r})=>{var a;return e.jsx(R,{...r,label:"开始日期",slotProps:{textField:{fullWidth:!0,required:!0,error:!!t.startDate,helperText:(a=t.startDate)==null?void 0:a.message,disabled:i}}})}})}),e.jsx(x,{size:{xs:12,sm:6},children:e.jsx(z,{name:"endDate",control:c,render:({field:r})=>{var a;return e.jsx(R,{...r,label:"结束日期",slotProps:{textField:{fullWidth:!0,required:!0,error:!!t.endDate,helperText:(a=t.endDate)==null?void 0:a.message,disabled:i}}})}})}),e.jsx(x,{size:{xs:12,sm:6},children:e.jsx(z,{name:"termType",control:c,render:({field:r})=>e.jsxs(Ne,{fullWidth:!0,required:!0,error:!!t.termType,disabled:i,children:[e.jsx(Fe,{children:"学期类型"}),e.jsxs(ke,{...r,label:"学期类型",children:[e.jsx(G,{value:"spring",children:"春季"}),e.jsx(G,{value:"fall",children:"秋季"})]}),t.termType&&e.jsx(Ae,{children:t.termType.message})]})})}),e.jsx(x,{size:{xs:12,sm:6},children:e.jsx(z,{name:"academicYear",control:c,render:({field:r})=>{var a;return e.jsx(B,{...r,label:"学年标识 (如 2023-2024)",fullWidth:!0,required:!0,error:!!t.academicYear,helperText:(a=t.academicYear)==null?void 0:a.message,disabled:i})}})}),((h=t.root)==null?void 0:h.serverError)&&e.jsx(x,{size:12,children:e.jsx(E,{severity:"error",children:t.root.serverError.message})})]})}),e.jsxs(Me,{sx:{px:3,pb:2},children:[e.jsx(S,{onClick:f,disabled:i,color:"inherit",children:"取消"}),e.jsx(S,{type:"submit",variant:"contained",disabled:i,children:i?e.jsx(ne,{size:24,color:"inherit"}):j?"更新":"创建"})]})]})},ns=()=>{const n=le(),{semesters:f,isLoading:g,error:l,totalCount:i,page:v,pageSize:j,isActivating:c}=oe(s=>s.adminSemesters),[F,p]=o.useState(!1),[t,d]=o.useState(null),[k,h]=o.useState(!1),[r,a]=o.useState(null),[M,P]=o.useState(null),[T,m]=o.useState({open:!1,message:"",severity:"info"}),[V,I]=o.useState(null),[b,J]=o.useState({page:v,pageSize:j}),[w,K]=o.useState([]),O=o.useCallback(()=>{const s=w.length>0?`${w[0].field},${w[0].sort}`:void 0;n(ie({page:b.page,pageSize:b.pageSize,sort:s}))},[n,b.page,b.pageSize,w]);o.useEffect(()=>{O()},[O]);const Q=()=>{d(null),I(null),p(!0)},U=s=>{d(s),I(null),p(!0)},X=s=>{const u=f.find(y=>y.semesterId===s);a(s),d(u||null),h(!0)},Z=s=>{const u=f.find(y=>y.semesterId===s);P(s),d(u||null),h(!0)},ee=async()=>{if(r!==null)try{await n(xe(r)).unwrap(),m({open:!0,message:"学期删除成功",severity:"success"})}catch(s){m({open:!0,message:`删除失败: ${(s==null?void 0:s.message)||s||"未知错误"}`,severity:"error"})}finally{a(null)}else if(M!==null)try{await n(fe(M)).unwrap(),m({open:!0,message:"当前学期设置成功",severity:"success"})}catch(s){m({open:!0,message:`设置失败: ${(s==null?void 0:s.message)||s||"未知错误"}`,severity:"error"})}finally{P(null)}h(!1),d(null)},Y=()=>{p(!1),d(null),I(null)},se=async s=>{I(null);try{t?(await n(pe({id:t.semesterId,payload:s})).unwrap(),m({open:!0,message:"学期更新成功",severity:"success"})):(await n(he(s)).unwrap(),m({open:!0,message:"学期创建成功",severity:"success"})),Y()}catch(u){const y=(u==null?void 0:u.message)||u||"操作失败";m({open:!0,message:y,severity:"error"}),I(y)}},te=s=>{J(s),n(me(s.page)),n(ue(s.pageSize))},re=s=>K(s),$=()=>m({...T,open:!1}),ae=[{field:"semesterName",headerName:"学期名称",width:250,flex:1},{field:"academicYear",headerName:"学年",width:120},{field:"termType",headerName:"类型",width:100,valueGetter:s=>s==="spring"?"春季":"秋季"},{field:"startDate",headerName:"开始日期",width:130,valueGetter:s=>H(s,"yyyy-MM-dd")},{field:"endDate",headerName:"结束日期",width:130,valueGetter:s=>H(s,"yyyy-MM-dd")},{field:"isCurrent",headerName:"当前学期",width:120,align:"center",headerAlign:"center",renderCell:s=>s.value?e.jsx(_,{icon:e.jsx(ve,{}),label:"是",color:"success",size:"small"}):e.jsx(_,{icon:e.jsx(Ee,{}),label:"否",size:"small"})},{field:"actions",headerName:"操作",type:"actions",width:220,getActions:({row:s})=>[e.jsx(S,{size:"small",startIcon:e.jsx(Ce,{}),onClick:()=>U(s),children:"编辑"}),...s.isCurrent?[]:[e.jsx(S,{size:"small",startIcon:e.jsx(Oe,{}),color:"primary",onClick:()=>Z(s.semesterId),disabled:c,children:"设为当前"})],e.jsx(S,{size:"small",startIcon:e.jsx(Se,{}),color:"error",onClick:()=>X(s.semesterId),disabled:s.isCurrent,children:"删除"})]}];return e.jsxs(de,{sx:{p:2,height:"calc(100vh - 64px - 48px - 32px)",display:"flex",flexDirection:"column"},children:[e.jsxs(W,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(ce,{variant:"h5",children:"学期管理"}),e.jsx(S,{variant:"contained",startIcon:e.jsx(ge,{}),onClick:Q,children:"新增学期"})]}),l&&!g&&e.jsx(E,{severity:"error",sx:{mb:2},children:l}),e.jsx(W,{sx:{flexGrow:1,width:"100%"},children:e.jsx(je,{rows:f,columns:ae,rowCount:i,loading:g||c,pageSizeOptions:[5,10,20],paginationModel:b,paginationMode:"server",onPaginationModelChange:te,sortingMode:"server",sortModel:w,onSortModelChange:re,getRowId:s=>s.semesterId,localeText:ye.components.MuiDataGrid.defaultProps.localeText,disableRowSelectionOnClick:!0})}),e.jsx($e,{open:F,onClose:Y,onSubmit:se,initialData:t,isSubmitting:g,apiError:V}),e.jsx(De,{open:k,onClose:()=>{h(!1),a(null),P(null),d(null)},onConfirm:ee,title:r?"确认删除学期":M?"确认激活学期":"确认操作",contentText:r?`您确定要删除学期 "${(t==null?void 0:t.semesterName)||""}" 吗？`:M?`您确定要将 "${(t==null?void 0:t.semesterName)||""}" 设为当前学期吗？所有其他学期将变为非当前。`:"请确认此操作。",isConfirming:g||c}),e.jsx(Pe,{open:T.open,autoHideDuration:5e3,onClose:$,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(E,{onClose:$,severity:T.severity,sx:{width:"100%"},variant:"filled",children:T.message})})]})};export{ns as default};
