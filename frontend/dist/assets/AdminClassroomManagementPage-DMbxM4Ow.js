import{r as o,j as e,M as h,d as A,C as te,u as oe,c as ae,ap as ne,P as ie,T as le,B as ce,ay as me,az as de,aA as ue,aB as pe,aC as he}from"./index-CKLgkD1v.js";import{A as xe,D as ge,z as fe,C as je,E as be,a as Ce}from"./ConfirmDialog-COXuYVOi.js";import{S as ve}from"./Search-HBhVGKX6.js";import{u as ye,C as N,s as Se,z as w}from"./index-Bf-gyStQ.js";import{D as qe,a as ze,b as Ie}from"./DialogContent-DRqBLQZ-.js";import{D as we}from"./DialogTitle-CHEgnswe.js";import{G as c}from"./Grid-CW7wBfPk.js";import{T as E,F as Ae}from"./TextField-CAILEkKj.js";import{F as G,I as L,S as $}from"./Select-JmEIo2-X.js";import{A as T}from"./Alert-DDDj34Iz.js";import{I as Fe}from"./InputAdornment-vymAwCB7.js";import{S as Me}from"./Snackbar-HS5EKS66.js";import"./index-BIM5zmIj.js";import"./toPropertyKey-BRA8pAMC.js";import"./typeof-QjJsDpFa.js";import"./FormControlLabel-Yt6LKP0L.js";import"./Chip-DfvBT8qY.js";import"./KeyboardArrowRight-BSJIH089.js";import"./TableCell-BtnOls6d.js";const Ne=w.object({building:w.string().min(1,"教学楼名称不能为空").max(50,"名称过长"),roomNumber:w.string().min(1,"教室编号不能为空").max(20,"编号过长"),capacity:w.coerce.number().int("容量必须是整数").min(1,"容量至少为1").max(1e3,"容量设置过大"),equipment:w.enum(["basic","multimedia","lab"],{required_error:"请选择设备类型"})}),Ee=({open:n,onClose:b,onSubmit:x,initialData:p,isSubmitting:m,apiError:d})=>{var F;const g=!!p,{control:f,handleSubmit:k,reset:C,formState:{errors:r},setError:t}=ye({resolver:Se(Ne),defaultValues:{building:"",roomNumber:"",capacity:30,equipment:"basic"}});o.useEffect(()=>{n&&C(g&&p?p:{building:"",roomNumber:"",capacity:30,equipment:"basic"})},[p,n,C,g]),o.useEffect(()=>{d&&(d.toLowerCase().includes("教室")||d.toLowerCase().includes("room")?t("roomNumber",{type:"manual",message:d}):t("root.serverError",{type:"custom",message:d}))},[d,t]);const u=async a=>{await x(a)};return e.jsxs(qe,{open:n,onClose:b,maxWidth:"xs",fullWidth:!0,PaperProps:{component:"form",onSubmit:k(u)},children:[e.jsx(we,{children:g?"编辑教室":"新增教室"}),e.jsx(ze,{children:e.jsxs(c,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(c,{size:12,children:e.jsx(N,{name:"building",control:f,render:({field:a})=>{var l;return e.jsx(E,{...a,label:"教学楼名称",fullWidth:!0,required:!0,error:!!r.building,helperText:(l=r.building)==null?void 0:l.message,disabled:m})}})}),e.jsx(c,{size:12,children:e.jsx(N,{name:"roomNumber",control:f,render:({field:a})=>{var l;return e.jsx(E,{...a,label:"教室编号",fullWidth:!0,required:!0,error:!!r.roomNumber,helperText:(l=r.roomNumber)==null?void 0:l.message,disabled:m})}})}),e.jsx(c,{size:12,children:e.jsx(N,{name:"capacity",control:f,render:({field:a})=>{var l;return e.jsx(E,{...a,label:"容纳人数",type:"number",fullWidth:!0,required:!0,error:!!r.capacity,helperText:(l=r.capacity)==null?void 0:l.message,disabled:m})}})}),e.jsx(c,{size:12,children:e.jsx(N,{name:"equipment",control:f,render:({field:a})=>e.jsxs(G,{fullWidth:!0,required:!0,error:!!r.equipment,disabled:m,children:[e.jsx(L,{children:"设备类型"}),e.jsxs($,{...a,label:"设备类型",children:[e.jsx(h,{value:"basic",children:"基础设备"}),e.jsx(h,{value:"multimedia",children:"多媒体教室"}),e.jsx(h,{value:"lab",children:"实验室"})]}),r.equipment&&e.jsx(Ae,{children:r.equipment.message})]})})}),((F=r.root)==null?void 0:F.serverError)&&e.jsx(c,{size:12,children:e.jsx(T,{severity:"error",children:r.root.serverError.message})})]})}),e.jsxs(Ie,{sx:{px:3,pb:2},children:[e.jsx(A,{onClick:b,disabled:m,color:"inherit",children:"取消"}),e.jsx(A,{type:"submit",variant:"contained",disabled:m,children:m?e.jsx(te,{size:24,color:"inherit"}):g?"更新教室":"创建教室"})]})]})},Ye=()=>{const n=oe(),{classrooms:b,isLoading:x,error:p,totalCount:m,page:d,pageSize:g,filterBuilding:f,filterEquipment:k}=ae(s=>s.adminClassrooms),[C,r]=o.useState(!1),[t,u]=o.useState(null),[F,a]=o.useState(!1),[l,D]=o.useState(null),[M,j]=o.useState({open:!1,message:"",severity:"info"}),[R,v]=o.useState(null),[y,H]=o.useState({page:d,pageSize:g}),[S,V]=o.useState([]),[q,J]=o.useState(f||""),[P,K]=o.useState(k||""),_=o.useCallback(s=>{var O;console.log("Debouncer called with equipment_eq:",(O=s.filter)==null?void 0:O.equipment_eq);const i=setTimeout(()=>{var I;console.log("setTimeout executing for equipment_eq:",(I=s.filter)==null?void 0:I.equipment_eq),n(ne(s))},500);return()=>{var I;console.log("Clearing timer for equipment_eq:",(I=s.filter)==null?void 0:I.equipment_eq),clearTimeout(i)}},[n]);o.useEffect(()=>{const s=S.length>0?`${S[0].field},${S[0].sort}`:void 0,i={};q&&q.trim()!==""&&(i.building_like=q),i.equipment_eq=P,_({page:y.page,pageSize:y.pageSize,sort:s,filter:i})},[y.page,y.pageSize,S,q,P,n,_]);const Q=()=>{u(null),v(null),r(!0)},U=s=>{u(s),v(null),r(!0)},X=s=>{const i=b.find(z=>z.classroomId===s);D(s),u(i||null),a(!0)},Y=async()=>{if(l!==null)try{await n(he(l)).unwrap(),j({open:!0,message:"教室删除成功",severity:"success"})}catch(s){j({open:!0,message:`删除失败: ${(s==null?void 0:s.message)||s||"未知错误"}`,severity:"error"})}finally{a(!1),D(null),u(null)}},B=()=>{r(!1),u(null),v(null)},Z=async s=>{v(null);try{t?(await n(ue({id:t.classroomId,payload:s})).unwrap(),j({open:!0,message:"教室更新成功",severity:"success"})):(await n(pe(s)).unwrap(),j({open:!0,message:"教室创建成功",severity:"success"})),B()}catch(i){const z=(i==null?void 0:i.message)||i||(t?"更新":"创建")+"教室时发生未知错误";j({open:!0,message:z,severity:"error"}),v(z)}},ee=s=>{H(s),n(me(s.page)),n(de(s.pageSize))},se=s=>V(s),W=()=>j({...M,open:!1}),re=[{field:"classroomId",headerName:"ID",width:90},{field:"building",headerName:"教学楼",width:200,flex:1},{field:"roomNumber",headerName:"教室编号",width:150},{field:"capacity",headerName:"容量",type:"number",width:100,align:"center",headerAlign:"center"},{field:"equipment",headerName:"设备类型",width:150,valueGetter:s=>{switch(s){case"basic":return"基础设备";case"multimedia":return"多媒体教室";case"lab":return"实验室";default:return s}}},{field:"actions",headerName:"操作",type:"actions",width:150,getActions:({row:s})=>[e.jsx(A,{size:"small",startIcon:e.jsx(be,{}),onClick:()=>U(s),children:"编辑"}),e.jsx(A,{size:"small",startIcon:e.jsx(Ce,{}),color:"error",onClick:()=>X(s.classroomId),children:"删除"})]}];return e.jsxs(ie,{sx:{p:2,height:"calc(100vh - 64px - 48px - 32px)",display:"flex",flexDirection:"column"},children:[e.jsx(le,{variant:"h5",component:"h1",gutterBottom:!0,children:"教室管理"}),e.jsxs(c,{container:!0,spacing:2,sx:{mb:2,alignItems:"center"},children:[e.jsx(c,{size:{xs:12,sm:4},children:e.jsx(E,{fullWidth:!0,size:"small",variant:"outlined",placeholder:"按教学楼搜索...",value:q,onChange:s=>J(s.target.value),InputProps:{startAdornment:e.jsxs(Fe,{position:"start",children:[" ",e.jsx(ve,{})," "]})}})}),e.jsx(c,{size:{xs:12,sm:4},children:e.jsxs(G,{fullWidth:!0,size:"small",children:[e.jsx(L,{children:"设备类型"}),e.jsxs($,{value:P,label:"设备类型",onChange:s=>K(s.target.value),children:[e.jsx(h,{value:"",children:e.jsx("em",{children:"全部类型"})}),e.jsx(h,{value:"basic",children:"基础设备"}),e.jsx(h,{value:"multimedia",children:"多媒体"}),e.jsx(h,{value:"lab",children:"实验室"})]})]})}),e.jsx(c,{size:{xs:12,sm:"auto"},sx:{ml:"auto"},children:e.jsx(A,{variant:"contained",startIcon:e.jsx(xe,{}),onClick:Q,children:"新增教室"})})]}),p&&!x&&e.jsx(T,{severity:"error",sx:{mb:2},children:p}),e.jsx(ce,{sx:{flexGrow:1,width:"100%"},children:e.jsx(ge,{rows:b,columns:re,rowCount:m,loading:x,pageSizeOptions:[10,25,50,100],paginationModel:y,paginationMode:"server",onPaginationModelChange:ee,sortingMode:"server",sortModel:S,onSortModelChange:se,getRowId:s=>s.classroomId,localeText:fe.components.MuiDataGrid.defaultProps.localeText,disableRowSelectionOnClick:!0})}),e.jsx(Ee,{open:C,onClose:B,onSubmit:Z,initialData:t,isSubmitting:x,apiError:R}),e.jsx(je,{open:F,onClose:()=>{a(!1),D(null),u(null)},onConfirm:Y,title:"确认删除教室",contentText:`您确定要删除教室 "${t==null?void 0:t.building} ${t==null?void 0:t.roomNumber}" 吗？如果该教室已被排课或考试占用，可能无法删除或会导致问题。`,isConfirming:x}),e.jsx(Me,{open:M.open,autoHideDuration:5e3,onClose:W,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(T,{onClose:W,severity:M.severity,sx:{width:"100%"},variant:"filled",children:M.message})})]})};export{Ye as default};
