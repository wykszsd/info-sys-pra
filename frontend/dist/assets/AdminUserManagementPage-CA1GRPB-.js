import{aQ as ge,j as e,a0 as be,aS as A,a9 as je,aa as se,b6 as E,r as x,a_ as re,a8 as ye,ah as Ce,M as O,d as $,C as we,u as Te,c as Q,bc as Se,ao as Pe,P as J,B as X,T as _e,bd as ve,be as Ie,bf as Fe,bg as Me,bh as ze,bi as Le}from"./index-CKLgkD1v.js";import{f as D,u as V,g as te,T as Ue,v as N,b as oe,c as W,G as Ge,d as ke,i as Ae,e as Re,h as $e,j as ee,k as Be,l as We,m as Ee,A as Ne,D as Oe,z as qe,C as De,E as Ve,a as He,n as Ye}from"./ConfirmDialog-COXuYVOi.js";import{S as Ze}from"./Search-HBhVGKX6.js";import{u as Ke,C as M,s as Qe,z as d}from"./index-Bf-gyStQ.js";import{D as Je,a as Xe,b as es}from"./DialogContent-DRqBLQZ-.js";import{D as ss}from"./DialogTitle-CHEgnswe.js";import{G as P}from"./Grid-CW7wBfPk.js";import{T as z,F as rs}from"./TextField-CAILEkKj.js";import{F as ts,I as os,S as ns}from"./Select-JmEIo2-X.js";import{A as q}from"./Alert-DDDj34Iz.js";import{I as ls}from"./InputAdornment-vymAwCB7.js";import{T as as,a as B}from"./Tabs-Cdd7RlJK.js";import{S as is}from"./Snackbar-HS5EKS66.js";import{C as cs}from"./Chip-DfvBT8qY.js";import"./index-BIM5zmIj.js";import"./toPropertyKey-BRA8pAMC.js";import"./typeof-QjJsDpFa.js";import"./FormControlLabel-Yt6LKP0L.js";import"./KeyboardArrowRight-BSJIH089.js";import"./TableCell-BtnOls6d.js";const ds=["className","children"],ms=l=>{const{classes:j}=l;return se({root:["toolbarContainer"]},te,j)},us=be(Ue,{name:"MuiDataGrid",slot:"ToolbarContainer",shouldForwardProp:l=>l!=="ownerState"})({display:"flex",alignItems:"center",flexWrap:"wrap",gap:N.spacing(1),padding:N.spacing(.5),minHeight:"auto"}),ps=D(function(j,I){const{className:t,children:a}=j,_=ge(j,ds),m=V(),o=ms(m);return a?e.jsx(us,A({className:je(o.root,t),ownerState:m},_,{ref:I,children:a})):null}),hs=D(function(j,I){var F,S;const{slotProps:t={}}=j,a=t.button||{},_=t.tooltip||{},m=oe(),o=V(),u=W(m,Re),y=E(),b=E(),[g,i]=x.useState(!1),T=x.useRef(null),f=re(I,T),k=[{icon:e.jsx(o.slots.densityCompactIcon,{}),label:m.current.getLocaleText("toolbarDensityCompact"),value:"compact"},{icon:e.jsx(o.slots.densityStandardIcon,{}),label:m.current.getLocaleText("toolbarDensityStandard"),value:"standard"},{icon:e.jsx(o.slots.densityComfortableIcon,{}),label:m.current.getLocaleText("toolbarDensityComfortable"),value:"comfortable"}],C=x.useMemo(()=>{switch(u){case"compact":return e.jsx(o.slots.densityCompactIcon,{});case"comfortable":return e.jsx(o.slots.densityComfortableIcon,{});default:return e.jsx(o.slots.densityStandardIcon,{})}},[u,o]),L=p=>{var c;i(v=>!v),(c=a.onClick)==null||c.call(a,p)},r=()=>{i(!1)},n=p=>{m.current.setDensity(p),i(!1)},w=p=>{p.key==="Tab"&&p.preventDefault(),Ae(p.key)&&i(!1)};if(o.disableDensitySelector)return null;const R=k.map((p,c)=>e.jsx(o.slots.baseMenuItem,{onClick:()=>n(p.value),selected:p.value===u,iconStart:p.icon,children:p.label},c));return e.jsxs(x.Fragment,{children:[e.jsx(o.slots.baseTooltip,A({title:m.current.getLocaleText("toolbarDensityLabel"),enterDelay:1e3},(F=o.slotProps)==null?void 0:F.baseTooltip,_,{children:e.jsx(o.slots.baseButton,A({size:"small",startIcon:C,"aria-label":m.current.getLocaleText("toolbarDensityLabel"),"aria-haspopup":"menu","aria-expanded":g,"aria-controls":g?b:void 0,id:y},(S=o.slotProps)==null?void 0:S.baseButton,a,{onClick:L,ref:f,children:m.current.getLocaleText("toolbarDensity")}))})),e.jsx(Ge,{open:g,target:T.current,onClose:r,position:"bottom-end",children:e.jsx(o.slots.baseMenuList,{id:b,className:ke.menuList,"aria-labelledby":y,onKeyDown:w,autoFocusItem:g,children:R})})]})}),xs=l=>{const{classes:j}=l;return se({root:["toolbarFilterList"]},te,j)},fs=ye("ul",{name:"MuiDataGrid",slot:"ToolbarFilterList"})({margin:N.spacing(1,1,.5),padding:N.spacing(0,1)}),gs=D(function(j,I){var w,R,F;const{slotProps:t={}}=j,a=t.button||{},_=t.tooltip||{},m=t.badge||{},o=oe(),u=V(),y=W(o,We),b=W(o,Ee),g=W(o,Be),i=xs(u),T=E(),f=E(),{filterPanelTriggerRef:k}=$e(),C=re(I,k),L=x.useMemo(()=>{if(g.open)return o.current.getLocaleText("toolbarFiltersTooltipHide");if(y.length===0)return o.current.getLocaleText("toolbarFiltersTooltipShow");const S=c=>b[c.field].filterOperators.find(v=>v.value===c.operator).label||o.current.getLocaleText(`filterOperator${Ce(c.operator)}`).toString(),p=c=>{const{getValueAsString:v}=b[c.field].filterOperators.find(G=>G.value===c.operator);return v?v(c.value):c.value};return e.jsxs("div",{children:[o.current.getLocaleText("toolbarFiltersTooltipActive")(y.length),e.jsx(fs,{className:i.root,ownerState:u,children:y.map((c,v)=>A({},b[c.field]&&e.jsx("li",{children:`${b[c.field].headerName||c.field}
                  ${S(c)}
                  ${c.value!=null?p(c):""}`},v)))})]})},[o,u,g.open,y,b,i]),r=S=>{var v;const{open:p,openedPanelValue:c}=g;p&&c===ee.filters?o.current.hidePreferences():o.current.showPreferences(ee.filters,f,T),(v=a.onClick)==null||v.call(a,S)};if(u.disableColumnFilter)return null;const n=g.open&&g.panelId===f;return e.jsx(u.slots.baseTooltip,A({title:L,enterDelay:1e3},(w=u.slotProps)==null?void 0:w.baseTooltip,_,{children:e.jsx(u.slots.baseButton,A({id:T,size:"small","aria-label":o.current.getLocaleText("toolbarFiltersLabel"),"aria-controls":n?f:void 0,"aria-expanded":n,"aria-haspopup":!0,startIcon:e.jsx(u.slots.baseBadge,A({badgeContent:y.length,color:"primary"},(R=u.slotProps)==null?void 0:R.baseBadge,m,{children:e.jsx(u.slots.openFilterButtonIcon,{})}))},(F=u.slotProps)==null?void 0:F.baseButton,a,{onClick:r,onPointerUp:S=>{var p;g.open&&S.stopPropagation(),(p=a.onPointerUp)==null||p.call(a,S)},ref:C,children:o.current.getLocaleText("toolbarFilters")}))}))}),H=d.object({_formMode:d.enum(["create","edit"]),username:d.string().min(3,"用户名/学号/工号至少3位").max(50,"用户名过长"),email:d.string().email({message:"请输入有效的邮箱地址"}).optional().or(d.literal("")),phone:d.string().regex(/^1[3-9]\d{9}$/,{message:"请输入有效的11位手机号"}).optional().or(d.literal("")),role:d.enum(["student","teacher","admin"]),password:d.string().optional(),confirmPassword:d.string().optional()}),bs=H.extend({role:d.literal("student"),class_name:d.string().min(2,"班级名称不能为空").max(50),enrollment_year:d.coerce.number().int("入学年份必须是整数").min(2e3,"年份过早").max(new Date().getFullYear()+2,"年份过远"),department:d.string().optional(),title:d.string().optional()}),js=H.extend({role:d.literal("teacher"),department:d.string().min(2,"所属院系不能为空").max(100),title:d.string().min(2,"职称不能为空").max(50),class_name:d.string().optional(),enrollment_year:d.coerce.number().optional()}),ys=H.extend({role:d.literal("admin"),class_name:d.string().optional(),enrollment_year:d.coerce.number().optional(),department:d.string().optional(),title:d.string().optional()}),Cs=d.discriminatedUnion("role",[bs,js,ys]).refine(l=>l.password||l.confirmPassword?l.password===l.confirmPassword:!0,{message:"两次输入的密码不一致",path:["confirmPassword"]}).refine(l=>l._formMode==="create"?l.password&&l.password.length>=6:l._formMode==="edit"&&l.password?l.password.length>=6:!0,{message:"创建时密码至少6位。更新时若提供新密码，也至少6位。",path:["password"]}),ws=({open:l,onClose:j,onSubmit:I,initialData:t,isSubmitting:a,apiError:_})=>{var L;const m=!!t,{control:o,handleSubmit:u,reset:y,watch:b,setError:g,formState:{errors:i},getValues:T}=Ke({resolver:Qe(Cs),defaultValues:{_formMode:"create",username:"",email:"",phone:"",role:"student",password:"",confirmPassword:"",class_name:"",enrollment_year:new Date().getFullYear(),department:"",title:""}}),f=b("role");x.useEffect(()=>{if(l){const r=t?"edit":"create";if(t){const n={_formMode:r,username:t.username,email:t.email||"",phone:t.phone||"",role:t.role,password:"",confirmPassword:""};let w={};t.role==="student"?w={class_name:t.class_name||"",enrollment_year:t.enrollment_year||new Date().getFullYear(),department:t.department||"",title:t.title||""}:t.role==="teacher"?w={department:t.department||"",title:t.title||"",class_name:t.class_name||"",enrollment_year:t.enrollment_year!==void 0&&t.enrollment_year!==null?t.enrollment_year:void 0}:w={class_name:t.class_name||"",enrollment_year:t.enrollment_year!==void 0&&t.enrollment_year!==null?t.enrollment_year:void 0,department:t.department||"",title:t.title||""},y({...n,...w})}else y({_formMode:r,username:"",email:"",phone:"",role:"student",password:"",confirmPassword:"",class_name:"",enrollment_year:new Date().getFullYear(),department:"",title:""})}},[t,l,y]),x.useEffect(()=>{_&&(_.toLowerCase().includes("username")||_.toLowerCase().includes("用户名")?g("username",{type:"server",message:_}):g("root.serverError",{type:"server",message:_}))},[_,g]);const k=async r=>{const n={username:r.username,email:r.email,phone:r.phone,role:r.role};r.password&&(n.password=r.password),r.role==="student"?(n.class_name=r.class_name,n.enrollment_year=r.enrollment_year):r.role==="teacher"&&(n.department=r.department,n.title=r.title),console.log("提交经过验证的用户 Payload:",n),await I(n)},C=r=>{var n;return(n=i[r])==null?void 0:n.message};return e.jsxs(Je,{open:l,onClose:j,maxWidth:"md",fullWidth:!0,PaperProps:{component:"form",onSubmit:u(k)},children:[e.jsx(ss,{children:m?`编辑用户: ${t==null?void 0:t.username}`:"新增用户"}),e.jsx(Xe,{children:e.jsxs(P,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(P,{size:{xs:12,sm:6},children:e.jsx(M,{name:"username",control:o,render:({field:r})=>{var n;return e.jsx(z,{...r,label:"用户名 (学号/工号)",fullWidth:!0,required:!0,error:!!i.username,helperText:(n=i.username)==null?void 0:n.message,disabled:a||m})}})}),e.jsx(P,{size:{xs:12,sm:6},children:e.jsx(M,{name:"role",control:o,render:({field:r})=>e.jsxs(ts,{fullWidth:!0,required:!0,error:!!i.role,disabled:a||m,children:[e.jsx(os,{children:"角色"}),e.jsxs(ns,{...r,label:"角色",children:[e.jsx(O,{value:"student",children:"学生"}),e.jsx(O,{value:"teacher",children:"教师"}),e.jsx(O,{value:"admin",children:"管理员"})]}),i.role&&e.jsx(rs,{children:i.role.message})]})})}),e.jsx(P,{size:{xs:12,sm:6},children:e.jsx(M,{name:"email",control:o,render:({field:r})=>{var n;return e.jsx(z,{...r,label:"邮箱 (可选)",type:"email",fullWidth:!0,error:!!i.email,helperText:(n=i.email)==null?void 0:n.message,disabled:a})}})}),e.jsx(P,{size:{xs:12,sm:6},children:e.jsx(M,{name:"phone",control:o,render:({field:r})=>{var n;return e.jsx(z,{...r,label:"手机号 (可选)",fullWidth:!0,error:!!i.phone,helperText:(n=i.phone)==null?void 0:n.message,disabled:a})}})}),e.jsx(P,{size:{xs:12,sm:6},children:e.jsx(M,{name:"password",control:o,render:({field:r})=>{var n;return e.jsx(z,{...r,label:m?"新密码 (留空则不修改)":"初始密码",type:"password",fullWidth:!0,required:!m&&T("_formMode")==="create",error:!!i.password,helperText:(n=i.password)==null?void 0:n.message,disabled:a})}})}),e.jsx(P,{size:{xs:12,sm:6},children:e.jsx(M,{name:"confirmPassword",control:o,render:({field:r})=>{var n;return e.jsx(z,{...r,label:"确认密码",type:"password",fullWidth:!0,required:!!b("password"),error:!!i.confirmPassword,helperText:(n=i.confirmPassword)==null?void 0:n.message,disabled:a||!b("password")})}})}),f==="student"&&e.jsxs(e.Fragment,{children:[e.jsx(P,{size:{xs:12,sm:6},children:e.jsx(M,{name:"class_name",control:o,render:({field:r})=>e.jsx(z,{...r,label:"班级名称",fullWidth:!0,required:f==="student",error:!!C("class_name"),helperText:C("class_name"),disabled:a})})}),e.jsx(P,{size:{xs:12,sm:6},children:e.jsx(M,{name:"enrollment_year",control:o,render:({field:r})=>e.jsx(z,{...r,label:"入学年份",type:"number",fullWidth:!0,required:f==="student",error:!!C("enrollment_year"),helperText:C("enrollment_year"),disabled:a})})})]}),f==="teacher"&&e.jsxs(e.Fragment,{children:[e.jsx(P,{size:{xs:12,sm:6},children:e.jsx(M,{name:"department",control:o,render:({field:r})=>e.jsx(z,{...r,label:"所属院系",fullWidth:!0,required:f==="teacher",error:!!C("department"),helperText:C("department"),disabled:a})})}),e.jsx(P,{size:{xs:12,sm:6},children:e.jsx(M,{name:"title",control:o,render:({field:r})=>e.jsx(z,{...r,label:"职称",fullWidth:!0,required:f==="teacher",error:!!C("title"),helperText:C("title"),disabled:a})})})]}),((L=i.root)==null?void 0:L.serverError)&&e.jsx(P,{size:{xs:12},children:e.jsx(q,{severity:"error",children:i.root.serverError.message})})]})}),e.jsxs(es,{sx:{px:3,pb:2},children:[e.jsx($,{onClick:j,disabled:a,color:"inherit",children:"取消"}),e.jsx($,{type:"submit",variant:"contained",disabled:a,children:a?e.jsx(we,{size:24,color:"inherit"}):m?"更新用户":"创建用户"})]})]})};function Ts(){return e.jsxs(ps,{children:[e.jsx(gs,{}),e.jsx(hs,{}),e.jsx(Ye,{csvOptions:{fileName:"用户列表",utf8WithBom:!0}})]})}const qs=()=>{const l=Te(),{users:j,isLoading:I,isSubmitting:t,error:a,totalCount:_,page:m,pageSize:o,filterRole:u,filterUsername:y}=Q(s=>s.adminUsers),b=Q(s=>s.auth.user),[g,i]=x.useState(!1),[T,f]=x.useState(null),[k,C]=x.useState(!1),[L,r]=x.useState(null),[n,w]=x.useState({open:!1,message:"",severity:"info"}),[R,F]=x.useState(null),[S,p]=x.useState({page:m,pageSize:o}),[c,v]=x.useState([]),[G,ne]=x.useState(y||"");x.useEffect(()=>{const s=setTimeout(()=>{G!==y&&l(Se(G))},500);return()=>clearTimeout(s)},[G,y,l]);const Y=x.useCallback(s=>{const h=setTimeout(()=>{l(Pe(s))},500);return()=>clearTimeout(h)},[l]);x.useEffect(()=>{const s=c.length>0?`${c[0].field},${c[0].sort}`:void 0;Y({page:S.page,pageSize:S.pageSize,sort:s,filterRole:u,filterUsername:G||void 0})},[S.page,S.pageSize,c,u,G,l,Y]);const le=()=>{f(null),F(null),i(!0)},ae=s=>{f(s),F(null),i(!0)},ie=s=>{const h=j.find(U=>U.userId===s);r(s),f(h||null),C(!0)},ce=async()=>{if(L!==null)try{await l(Le(L)).unwrap(),w({open:!0,message:"用户删除成功！",severity:"success"})}catch(s){w({open:!0,message:`删除失败: ${(s==null?void 0:s.message)||s||"未知错误"}`,severity:"error"})}finally{C(!1),r(null),f(null)}},Z=()=>{i(!1),f(null),F(null)},de=async s=>{F(null);try{T?(await l(Me({id:T.userId,payload:s})).unwrap(),w({open:!0,message:"用户更新成功！",severity:"success"})):(await l(ze(s)).unwrap(),w({open:!0,message:"用户创建成功！",severity:"success"})),Z()}catch(h){const U=(h==null?void 0:h.message)||h||(T?"更新":"创建")+"用户时发生未知错误";w({open:!0,message:U,severity:"error"}),F(U)}},me=s=>{l(Ie(s.page)),l(Fe(s.pageSize)),p(s)},ue=s=>v(s),K=()=>w({...n,open:!1}),pe=(s,h)=>{l(ve(h))},he=s=>{ne(s.target.value)},xe=[{field:"userId",headerName:"ID",width:70},{field:"username",headerName:"用户名 (学号/工号)",width:180,flex:.5},{field:"role",headerName:"角色",width:100,renderCell:({value:s})=>{let h="default",U=s;return s==="admin"?(h="secondary",U="管理员"):s==="teacher"?(h="primary",U="教师"):s==="student"&&(U="学生"),e.jsx(cs,{label:U,size:"small",color:h,variant:"outlined"})}},{field:"email",headerName:"邮箱",width:220,flex:.7},{field:"phone",headerName:"手机号",width:130},{field:"details",headerName:"角色详情",width:280,sortable:!1,flex:1,valueGetter:(s,h)=>h.role==="student"?`班级: ${h.class_name||"-"}, 入学年份: ${h.enrollment_year||"-"}`:h.role==="teacher"?`院系: ${h.department||"-"}, 职称: ${h.title||"-"}`:"无特定详情"},{field:"actions",headerName:"操作",type:"actions",width:160,getActions:({row:s})=>[e.jsx($,{size:"small",startIcon:e.jsx(Ve,{}),onClick:()=>ae(s),children:"编辑"},`edit-${s.userId}`),e.jsx($,{size:"small",startIcon:e.jsx(He,{}),color:"error",onClick:()=>ie(s.userId),disabled:s.username==="admin"||(b==null?void 0:b.userId)===s.userId,children:"删除"},`delete-${s.userId}`)]}],fe=x.useMemo(()=>xe,[b]);return e.jsxs(J,{sx:{p:2,height:"calc(100vh - 64px - 48px - 16px - 16px)",display:"flex",flexDirection:"column"},children:[e.jsxs(X,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,flexWrap:"wrap",gap:2},children:[e.jsx(_e,{variant:"h5",component:"h1",children:"用户管理"}),e.jsx($,{variant:"contained",startIcon:e.jsx(Ne,{}),onClick:le,children:"新增用户"})]}),e.jsx(J,{elevation:1,sx:{p:2,mb:2},children:e.jsxs(P,{container:!0,spacing:2,alignItems:"center",children:[e.jsxs(P,{size:{xs:12,md:4},children:[" ",e.jsx(z,{fullWidth:!0,size:"small",variant:"outlined",placeholder:"搜索用户名/学号/工号...",value:G,onChange:he,InputProps:{startAdornment:e.jsxs(ls,{position:"start",children:[" ",e.jsx(Ze,{})," "]})}})]}),e.jsxs(P,{size:{xs:12,md:8},children:[" ",e.jsxs(as,{value:u,onChange:pe,indicatorColor:"primary",textColor:"primary",variant:"scrollable",scrollButtons:"auto",allowScrollButtonsMobile:!0,children:[e.jsx(B,{label:"全部角色",value:"all"}),e.jsx(B,{label:"学生",value:"student"}),e.jsx(B,{label:"教师",value:"teacher"}),e.jsx(B,{label:"管理员",value:"admin"})]})]})]})}),a&&!I&&e.jsx(q,{severity:"error",sx:{mb:2},children:a}),e.jsx(X,{sx:{flexGrow:1,width:"100%"},children:e.jsx(Oe,{rows:j,columns:fe,rowCount:_,loading:I||t,pageSizeOptions:[10,25,50,100],paginationModel:S,paginationMode:"server",onPaginationModelChange:me,sortingMode:"server",sortModel:c,onSortModelChange:ue,getRowId:s=>s.userId,localeText:qe.components.MuiDataGrid.defaultProps.localeText,disableRowSelectionOnClick:!0,slots:{toolbar:Ts}})}),g&&e.jsx(ws,{open:g,onClose:Z,onSubmit:de,initialData:T,isSubmitting:t,apiError:R}),e.jsx(De,{open:k,onClose:()=>{C(!1),r(null),f(null)},onConfirm:ce,title:"确认删除用户",contentText:`您确定要删除用户 "${(T==null?void 0:T.username)||""}" 吗？此操作通常无法撤销。`,isConfirming:t}),e.jsx(is,{open:n.open,autoHideDuration:5e3,onClose:K,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(q,{onClose:K,severity:n.severity,sx:{width:"100%"},variant:"filled",children:n.message})})]})};export{qs as default};
