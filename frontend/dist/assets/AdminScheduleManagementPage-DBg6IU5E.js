import{e as we,j as e,r as i,B as V,C as me,T as ee,M as G,d as L,u as Ee,c as O,bj as _e,bk as De,W as Me,E as Oe,aq as qe,as as We,P as ge,bl as Z,bm as xe,bn as Ge,bo as Re,bp as Be,bq as He}from"./index-CKLgkD1v.js";import{A as Je,D as Ye,z as Ke,C as Qe,E as Ue,a as Xe}from"./ConfirmDialog-COXuYVOi.js";import{u as Ze,C as E,s as Ve,z as A}from"./index-Bf-gyStQ.js";import{W as es}from"./WeekPicker-CSi71gVf.js";import{D as ss,a as rs,b as ts}from"./DialogContent-DRqBLQZ-.js";import{D as ls}from"./DialogTitle-CHEgnswe.js";import{G as u}from"./Grid-CW7wBfPk.js";import{A as N}from"./FormControlLabel-Yt6LKP0L.js";import{T as F,F as pe}from"./TextField-CAILEkKj.js";import{F as Ie,I as fe,S as je}from"./Select-JmEIo2-X.js";import{A as se}from"./Alert-DDDj34Iz.js";import{S as os}from"./Snackbar-HS5EKS66.js";import"./index-BIM5zmIj.js";import"./toPropertyKey-BRA8pAMC.js";import"./typeof-QjJsDpFa.js";import"./Chip-DfvBT8qY.js";import"./KeyboardArrowRight-BSJIH089.js";import"./TableCell-BtnOls6d.js";import"./InputAdornment-vymAwCB7.js";import"./InfoOutlined-CEViPEnt.js";import"./timetableUtils-zizOuD1G.js";const ns=we(e.jsx("path",{d:"M10 18h4v-2h-4zM3 6v2h18V6zm3 7h12v-2H6z"})),as=A.object({courseId:A.number({invalid_type_error:"请选择课程",required_error:"课程不能为空"}),teacherId:A.string({required_error:"请选择授课教师"}).min(1,"授课教师不能为空"),classroomId:A.number({invalid_type_error:"请选择上课教室",required_error:"教室不能为空"}),sectionId:A.number({invalid_type_error:"请选择节次",required_error:"节次不能为空"}),weekDay:A.number({invalid_type_error:"请选择星期",required_error:"星期不能为空"}).min(1).max(7),weeks:A.string().min(1,"周次不能为空").regex(/^((\d{1,2}(-\d{1,2})?)(,\s*\d{1,2}(-\d{1,2})?)*)$|^(\d{1,2})$/,"周次格式不正确 (示例: 1-8,10 或 5)")}),is=({open:a,onClose:_,onSubmit:I,initialData:d,isSubmitting:g,apiFormError:y,allCourses:c,allTeachers:f,allClassrooms:j,allSections:C,isLoadingDependencies:h})=>{var $;const x=!!d,{control:m,handleSubmit:b,reset:p,formState:{errors:n},setError:S}=Ze({resolver:Ve(as),defaultValues:{courseId:void 0,teacherId:void 0,classroomId:void 0,sectionId:void 0,weekDay:void 0,weeks:""}});i.useEffect(()=>{a&&p(x&&d?{courseId:d.courseId,teacherId:d.teacherId,classroomId:d.classroomId,sectionId:d.sectionId,weekDay:d.weekDay,weeks:d.weeks}:{courseId:void 0,teacherId:void 0,classroomId:void 0,sectionId:void 0,weekDay:void 0,weeks:""})},[d,a,p,x]),i.useEffect(()=>{y&&(y.toLowerCase().includes("conflict")||y.toLowerCase().includes("冲突")?S("root.apiError",{type:"manual",message:`排课冲突: ${y}`}):S("root.apiError",{type:"manual",message:y}))},[y,S]);const k=async o=>{const r={...o};await I(r)};return e.jsxs(ss,{open:a,onClose:_,maxWidth:"md",fullWidth:!0,PaperProps:{component:"form",onSubmit:b(k)},children:[e.jsx(ls,{children:x?`编辑排课 (ID: ${d==null?void 0:d.scheduleId})`:"新增排课"}),e.jsxs(rs,{children:[h&&e.jsxs(V,{sx:{display:"flex",justifyContent:"center",my:2},children:[e.jsx(me,{size:24}),e.jsx(ee,{sx:{ml:1},children:"加载选项数据..."})]}),e.jsxs(u,{container:!0,spacing:2,sx:{mt:.5},children:[e.jsx(u,{size:{xs:12,sm:6},children:e.jsx(E,{name:"courseId",control:m,render:({field:o})=>e.jsx(N,{options:c,getOptionLabel:r=>`${r.courseCode} - ${r.courseName}`,value:c.find(r=>r.courseId===o.value)||null,onChange:(r,t)=>o.onChange(t==null?void 0:t.courseId),isOptionEqualToValue:(r,t)=>r.courseId===(t==null?void 0:t.courseId),renderInput:r=>{var t;return e.jsx(F,{...r,label:"选择课程",required:!0,error:!!n.courseId,helperText:(t=n.courseId)==null?void 0:t.message})},disabled:g||h||c.length===0})})}),e.jsx(u,{size:{xs:12,sm:6},children:e.jsx(E,{name:"teacherId",control:m,render:({field:o})=>e.jsx(N,{options:f,getOptionLabel:r=>`${r.name} (${r.teacherId})`,value:f.find(r=>r.teacherId===o.value)||null,onChange:(r,t)=>o.onChange(t==null?void 0:t.teacherId),isOptionEqualToValue:(r,t)=>r.teacherId===(t==null?void 0:t.teacherId),renderInput:r=>{var t;return e.jsx(F,{...r,label:"选择教师",required:!0,error:!!n.teacherId,helperText:(t=n.teacherId)==null?void 0:t.message})},disabled:g||h||f.length===0})})}),e.jsx(u,{size:{xs:12,sm:6,md:4},children:e.jsx(E,{name:"classroomId",control:m,render:({field:o})=>e.jsx(N,{options:j,getOptionLabel:r=>`${r.building} ${r.roomNumber} (容:${r.capacity})`,value:j.find(r=>r.classroomId===o.value)||null,onChange:(r,t)=>o.onChange(t==null?void 0:t.classroomId),isOptionEqualToValue:(r,t)=>r.classroomId===(t==null?void 0:t.classroomId),renderInput:r=>{var t;return e.jsx(F,{...r,label:"选择教室",required:!0,error:!!n.classroomId,helperText:(t=n.classroomId)==null?void 0:t.message})},disabled:g||h||j.length===0})})}),e.jsx(u,{size:{xs:12,sm:6,md:4},children:e.jsx(E,{name:"sectionId",control:m,render:({field:o})=>e.jsxs(Ie,{fullWidth:!0,required:!0,error:!!n.sectionId,disabled:g||h||C.length===0,children:[e.jsx(fe,{children:"选择节次"}),e.jsxs(je,{labelId:"sectionId-select-label",...o,value:o.value===void 0?"":o.value,label:"选择节次",onChange:r=>{const t=r.target.value;typeof t=="string"&&t===""?o.onChange(void 0):o.onChange(Number(t))},children:["                            ",e.jsx(G,{value:"",children:e.jsx("em",{children:"请选择节次"})})," ",C.map(r=>e.jsx(G,{value:r.sectionId,children:`第${r.sectionId}节 (${r.startTime.substring(0,5)}-${r.endTime.substring(0,5)})`},r.sectionId))]}),n.sectionId&&e.jsx(pe,{children:n.sectionId.message})]})})}),e.jsx(u,{size:{xs:12,sm:6,md:4},children:e.jsx(E,{name:"weekDay",control:m,render:({field:o})=>e.jsxs(Ie,{fullWidth:!0,required:!0,error:!!n.weekDay,disabled:g,children:[e.jsx(fe,{children:"选择星期"}),e.jsxs(je,{labelId:"weekDay-select-label",...o,value:o.value===void 0?"":o.value,label:"选择星期",onChange:r=>{const t=r.target.value;typeof t=="string"&&t===""?o.onChange(void 0):o.onChange(Number(t))},children:[e.jsx(G,{value:"",children:e.jsx("em",{children:"请选择星期"})})," ",[1,2,3,4,5,6,7].map(r=>e.jsx(G,{value:r,children:`周${["一","二","三","四","五","六","日"][r-1]}`},r))]}),n.weekDay&&e.jsx(pe,{children:n.weekDay.message})]})})}),e.jsx(u,{size:12,children:e.jsx(E,{name:"weeks",control:m,render:({field:o})=>{var r;return e.jsx(es,{value:o.value,onChange:t=>o.onChange(t),label:"选择教学周次 *",error:!!n.weeks,helperText:(r=n.weeks)==null?void 0:r.message})}})}),(($=n.root)==null?void 0:$.apiError)&&e.jsx(u,{size:12,children:e.jsx(se,{severity:"error",children:n.root.apiError.message})})]})]}),e.jsxs(ts,{sx:{px:3,pb:2},children:[e.jsx(L,{onClick:_,disabled:g,color:"inherit",children:"取消"}),e.jsx(L,{type:"submit",variant:"contained",disabled:g||h,children:g?e.jsx(me,{size:24,color:"inherit"}):x?"更新排课":"创建排课"})]})]})},Ls=()=>{var de,ce,ue;const a=Ee(),{schedules:_,isLoading:I,isSubmitting:d,error:g,totalCount:y,page:c,pageSize:f,filterCourseId:j,filterTeacherId:C,filterClassroomId:h,filterSemesterId:x}=O(s=>s.adminSchedules),m=O(s=>s.sharedData),b=m.allCoursesShort,p=m.allTeachers,n=m.allClassroomsShort,S=((de=m.isLoading)==null?void 0:de.courses)??!1,k=((ce=m.isLoading)==null?void 0:ce.teachers)??!1,$=((ue=m.isLoading)==null?void 0:ue.classrooms)??!1,o=O(s=>s.timetable.allSections),r=O(s=>s.timetable.isLoadingSections),{semesters:t,isLoading:D}=O(s=>s.adminSemesters),[re,R]=i.useState(!1),[v,P]=i.useState(null),[Ce,B]=i.useState(!1),[te,le]=i.useState(null),[q,w]=i.useState({open:!1,message:"",severity:"info"}),[be,M]=i.useState(null),[z,Se]=i.useState([]),[H,J]=i.useState(j||null),[Y,K]=i.useState(C||null),[Q,U]=i.useState(h||null),[W,X]=i.useState(x||null);i.useEffect(()=>{console.log("[Effect] Dropdown data fetch triggered. Current loading states:",{isLoadingCourses:S,isLoadingTeachers:k,isLoadingClassrooms:$,isLoadingSections:r,isLoadingSemestersForFilter:D}),b.length===0&&!S&&a(_e()),p.length===0&&!k&&a(De()),n.length===0&&!$&&a(Me()),o.length===0&&!r&&a(Oe()),(!t||t.length===0)&&!D&&a(qe({page:0,pageSize:200}))},[a,b.length,p.length,n.length,o.length,t==null?void 0:t.length,S,k,$,r,D]);const oe=i.useMemo(()=>JSON.stringify(z),[z]);i.useEffect(()=>{console.log(`[Effect] Fetching admin schedules. Page: ${c}, PageSize: ${f}, Sort: ${oe}, Filters:`,{reduxFilterCourseId:j,reduxFilterTeacherId:C,reduxFilterClassroomId:h,reduxFilterSemesterId:x});const s=z.length>0?`${z[0].field},${z[0].sort}`:void 0;a(We({page:c,pageSize:f,sort:s,filterCourseId:j,filterTeacherId:C,filterClassroomId:h,filterSemesterId:x}))},[a,c,f,oe,j,C,h,x]),i.useEffect(()=>{J(j||null),K(C||null),U(h||null),X(x||null)},[j,C,h,x]);const ve=s=>{console.log("[Event] handlePaginationModelChange triggered. New model:",s,"Current Redux: page=",c,"pageSize=",f);let l=!1;s.page!==c&&(console.log("  Page changed. Dispatching setAdminSchedulePage:",s.page),a(Z(s.page)),l=!0),s.pageSize!==f&&(console.log("  PageSize changed. Dispatching setAdminSchedulePageSize:",s.pageSize),a(Ge(s.pageSize)),l=!0),l||console.log("  Pagination model did not change relevant values.")},ye=s=>{console.log("[Event] handleSortModelChange triggered. New model:",s,"Current sortModel:",z),JSON.stringify(s)!==JSON.stringify(z)?(console.log("  Sort model content changed. Setting new sortModel."),Se(s)):console.log("  Sort model content is the same. Not updating state.")},$e=()=>{console.log("[Event] handleApplyFilters. Resetting page to 0 if not already. Current reduxPage:",c),c!==0&&a(Z(0)),a(xe({filterCourseId:H,filterTeacherId:Y,filterClassroomId:Q,filterSemesterId:W}))},ze=()=>{console.log("[Event] handleClearFilters. Resetting page to 0 if not already. Current reduxPage:",c),J(null),K(null),U(null),X(null),c!==0&&a(Z(0)),a(xe({filterCourseId:null,filterTeacherId:null,filterClassroomId:null,filterSemesterId:null}))},ke=()=>{P(null),M(null),R(!0)},Te=s=>{P(s),M(null),R(!0)},Ae=s=>{const l=_.find(T=>T.scheduleId===s);P(l||null),le(s),B(!0)},Le=async()=>{if(te!==null)try{await a(He(te)).unwrap(),w({open:!0,message:"排课删除成功",severity:"success"})}catch(s){w({open:!0,message:`删除失败: ${(s==null?void 0:s.message)||String(s)||"未知错误"}`,severity:"error"})}finally{B(!1),le(null),P(null)}},ne=()=>{R(!1),P(null),M(null)},Ne=async s=>{M(null);try{v?(await a(Re({id:v.scheduleId,payload:s})).unwrap(),w({open:!0,message:"排课更新成功",severity:"success"})):(await a(Be(s)).unwrap(),w({open:!0,message:"排课创建成功",severity:"success"})),ne()}catch(l){const T=(l==null?void 0:l.message)||String(l)||"操作失败";w({open:!0,message:T,severity:"error"}),M(T)}},ae=()=>w({...q,open:!1}),Fe=[{field:"scheduleId",headerName:"ID",width:70},{field:"courseName",headerName:"课程",width:200,valueGetter:(s,l)=>`${l.courseCode||""} ${l.courseName||`(ID:${l.courseId})`}`},{field:"teacherName",headerName:"教师",width:120,valueGetter:(s,l)=>l.teacherName||`(ID:${l.teacherId})`},{field:"classroomInfo",headerName:"教室",width:150,valueGetter:(s,l)=>`${l.classroomBuilding} ${l.classroomRoomNumber}`},{field:"timeInfo",headerName:"时间",width:180,valueGetter:(s,l)=>{var T,he;return`周${["一","二","三","四","五","六","日"][l.weekDay-1]} 第${l.sectionId}节 (${(T=l.startTime)==null?void 0:T.substring(0,5)}-${(he=l.endTime)==null?void 0:he.substring(0,5)})`}},{field:"weeks",headerName:"周次",width:180,flex:1},{field:"actions",headerName:"操作",type:"actions",width:150,getActions:({row:s})=>[e.jsx(L,{size:"small",startIcon:e.jsx(Ue,{}),onClick:()=>Te(s),children:"编辑"},`edit-${s.scheduleId}`),e.jsx(L,{size:"small",startIcon:e.jsx(Xe,{}),color:"error",onClick:()=>Ae(s.scheduleId),children:"删除"},`delete-${s.scheduleId}`)]}],Pe=H||Y||Q||W,ie=S||k||$||r||D;return e.jsxs(ge,{sx:{p:2,height:"calc(100vh - 64px - 48px - 32px)",display:"flex",flexDirection:"column"},children:[e.jsxs(V,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(ee,{variant:"h5",children:"排课管理"}),e.jsx(L,{variant:"contained",startIcon:e.jsx(Je,{}),onClick:ke,disabled:ie,children:"新增排课"})]}),e.jsxs(ge,{elevation:2,sx:{p:2,mb:2},children:[e.jsx(ee,{variant:"subtitle1",gutterBottom:!0,children:"筛选排课"}),e.jsxs(u,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(u,{size:{xs:12,sm:6,md:3},children:e.jsx(N,{fullWidth:!0,size:"small",options:t||[],getOptionLabel:s=>`${s.semesterName} (${s.academicYear})`,value:(t==null?void 0:t.find(s=>s.semesterId===W))||null,onChange:(s,l)=>X((l==null?void 0:l.semesterId)||null),renderInput:s=>e.jsx(F,{...s,label:"学期 (筛选条件)"}),loading:D,disabled:I})}),e.jsx(u,{size:{xs:12,sm:6,md:3},children:e.jsx(N,{fullWidth:!0,size:"small",options:b||[],getOptionLabel:s=>`${s.courseCode} ${s.courseName}`,value:(b==null?void 0:b.find(s=>s.courseId===H))||null,onChange:(s,l)=>J((l==null?void 0:l.courseId)||null),renderInput:s=>e.jsx(F,{...s,label:"课程"}),loading:S,disabled:I})}),e.jsx(u,{size:{xs:12,sm:6,md:3},children:e.jsx(N,{fullWidth:!0,size:"small",options:p||[],getOptionLabel:s=>`${s.name} (${s.teacherId})`,value:(p==null?void 0:p.find(s=>s.teacherId===Y))||null,onChange:(s,l)=>K((l==null?void 0:l.teacherId)||null),renderInput:s=>e.jsx(F,{...s,label:"教师"}),loading:k,disabled:I})}),e.jsx(u,{size:{xs:12,sm:6,md:3},children:e.jsx(N,{fullWidth:!0,size:"small",options:n||[],getOptionLabel:s=>`${s.building} ${s.roomNumber}`,value:(n==null?void 0:n.find(s=>s.classroomId===Q))||null,onChange:(s,l)=>U((l==null?void 0:l.classroomId)||null),renderInput:s=>e.jsx(F,{...s,label:"教室"}),loading:$,disabled:I})}),e.jsxs(u,{size:{xs:12},sx:{display:"flex",justifyContent:"flex-end",gap:1,mt:1},children:[e.jsx(L,{variant:"outlined",onClick:ze,disabled:I||!Pe,children:"清空筛选"}),e.jsx(L,{variant:"contained",startIcon:e.jsx(ns,{}),onClick:$e,disabled:I||!W,children:"应用筛选"})]})]})]}),g&&!I&&e.jsx(se,{severity:"error",sx:{mb:2},children:g}),e.jsx(V,{sx:{flexGrow:1,width:"100%"},children:e.jsx(Ye,{rows:_,columns:Fe,rowCount:y,loading:I||d,pageSizeOptions:[10,25,50],paginationModel:{page:c,pageSize:f},paginationMode:"server",onPaginationModelChange:ve,sortingMode:"server",sortModel:z,onSortModelChange:ye,getRowId:s=>s.scheduleId,localeText:Ke.components.MuiDataGrid.defaultProps.localeText,disableRowSelectionOnClick:!0})}),re&&e.jsx(is,{open:re,onClose:ne,onSubmit:Ne,initialData:v,isSubmitting:d,apiFormError:be,allCourses:b||[],allTeachers:p||[],allClassrooms:n||[],allSections:o||[],isLoadingDependencies:ie}),e.jsx(Qe,{open:Ce,onClose:()=>{B(!1),P(null)},onConfirm:Le,title:"确认删除排课",contentText:`您确定要删除排课记录 ${(v==null?void 0:v.courseName)||""} (ID: ${v==null?void 0:v.scheduleId}) 吗？`,isConfirming:d}),e.jsx(os,{open:q.open,autoHideDuration:5e3,onClose:ae,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(se,{onClose:ae,severity:q.severity,sx:{width:"100%"},variant:"filled",children:q.message})})]})};export{Ls as default};
