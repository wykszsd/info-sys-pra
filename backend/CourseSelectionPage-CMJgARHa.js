import{e as M,j as e,T as v,f as I,B as A,C as N,d as z,P as D,u as V,c as L,r as x,F as G,G as J,H as K,J as _,K as q,L as Q}from"./index-CKLgkD1v.js";import{S as U}from"./Search-HBhVGKX6.js";import{L as X}from"./LocationOn-qhTYfCyv.js";import{I as Y}from"./InfoOutlined-CEViPEnt.js";import{C as Z}from"./CheckCircleOutline-B9_rkMsl.js";import{C as ee}from"./CancelOutlined-BJumekxO.js";import{c as O,T as se,a as te,b as ne,d as re}from"./TableRow-DM6qFwiW.js";import{T as c}from"./TableCell-BtnOls6d.js";import{C}from"./Chip-DfvBT8qY.js";import{A as y}from"./Alert-DDDj34Iz.js";import{S as ae}from"./Snackbar-HS5EKS66.js";import{T as ie}from"./TextField-CAILEkKj.js";import{I as le}from"./InputAdornment-vymAwCB7.js";import"./Select-JmEIo2-X.js";const oe=M(e.jsx("path",{d:"M12 2c-4.97 0-9 4.03-9 9 0 4.17 2.84 7.67 6.69 8.69L12 22l2.31-2.31C18.16 18.67 21 15.17 21 11c0-4.97-4.03-9-9-9m0 2c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3m0 14.3c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22"})),ce=M([e.jsx("path",{d:"M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"},"0"),e.jsx("path",{d:"M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"},"1")]),de=s=>{const i=["一","二","三","四","五","六","日"],u=s.weekDay?`周${i[s.weekDay-1]}`:"待定",l=s.startTime&&s.endTime?`${s.startTime.substring(0,5)}-${s.endTime.substring(0,5)}`:"时间待定",h=s.weeks||"周次待定";return`${u} ${l} [${h}]`},me=({course:s,enrollment:i,onEnroll:u,onWithdraw:l,isProcessingAction:h})=>{const o=!!i&&i.status==="enrolled",a=s.enrolledCount??0,t=s.maxCapacity??1/0,d=a>=t,m=!o&&!d,j=o,p=()=>{m&&!h&&u(s.scheduleId)},w=()=>{j&&i&&!h&&l(i.enrollmentId,s.scheduleId)};return e.jsxs(O,{hover:!0,sx:{"&:last-child td, &:last-child th":{border:0}},children:[e.jsxs(c,{children:[e.jsx(v,{variant:"subtitle2",component:"div",fontWeight:"medium",children:s.courseName}),e.jsx(v,{variant:"caption",color:"text.secondary",children:s.courseCode})]}),e.jsx(c,{children:e.jsx(I,{title:"授课教师",children:e.jsx(C,{icon:e.jsx(oe,{fontSize:"small"}),label:s.teacherName||"待定",size:"small",variant:"outlined"})})}),e.jsx(c,{align:"center",children:e.jsx(I,{title:"学分",children:e.jsx(C,{label:`${s.credit||"N/A"} 分`,size:"small"})})}),e.jsx(c,{children:e.jsx(I,{title:"上课安排",children:e.jsxs(A,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[e.jsx(C,{icon:e.jsx(ce,{fontSize:"small"}),label:de(s),size:"small",variant:"outlined",sx:{mb:.5}}),e.jsx(C,{icon:e.jsx(X,{fontSize:"small"}),label:`${s.classroomBuilding||"教学楼待定"} ${s.classroomRoomNumber||"教室待定"}`,size:"small",variant:"outlined"})]})})}),e.jsx(c,{align:"center",children:e.jsx(I,{title:s.maxCapacity===void 0?"名额信息暂无":`已选 ${a} / 容量 ${t===1/0?"无限制":t}`,children:e.jsx(C,{label:s.maxCapacity===void 0?"N/A":`${a}/${t===1/0?"∞":t}`,size:"small",color:d?"error":a/(t===1/0?a+1:t)>=.8?"warning":"success",variant:"filled"})})}),e.jsx(c,{align:"center",children:h?e.jsx(N,{size:24}):o?e.jsx(z,{variant:"outlined",color:"error",size:"small",onClick:w,disabled:!j,startIcon:e.jsx(ee,{}),children:"退选"}):e.jsx(z,{variant:"contained",color:d&&t!==1/0?"inherit":"primary",size:"small",onClick:p,disabled:!m||d&&t!==1/0,startIcon:d&&t!==1/0?e.jsx(Y,{}):e.jsx(Z,{}),children:d&&t!==1/0?"已满":"选课"})})]})},he=({courses:s,enrollmentsMap:i,onEnroll:u,onWithdraw:l,processingActions:h})=>!s||s.length===0?e.jsx(y,{severity:"info",sx:{mt:3,mx:1},children:"当前学期暂无可选择的课程，或请尝试调整筛选条件。"}):e.jsx(se,{component:D,elevation:3,sx:{mt:2},children:e.jsxs(te,{stickyHeader:!0,"aria-label":"可选课程列表",children:[e.jsx(ne,{children:e.jsxs(O,{sx:{"& th":{backgroundColor:"grey.200",fontWeight:"bold"}},children:[e.jsx(c,{children:"课程名称 / 代码"}),e.jsx(c,{children:"教师"}),e.jsx(c,{align:"center",children:"学分"}),e.jsx(c,{children:"时间 / 地点 / 周次"}),e.jsx(c,{align:"center",children:"名额 (已选/容量)"}),e.jsx(c,{align:"center",children:"操作"})]})}),e.jsx(re,{children:s.map(o=>{const a=i.get(o.scheduleId),t=h.has(o.scheduleId);return e.jsx(me,{course:o,enrollment:a,onEnroll:u,onWithdraw:l,isProcessingAction:t},o.scheduleId)})})]})}),Te=()=>{const s=V(),{selectableCourses:i,myEnrollments:u,isLoading:l,isEnrolling:h,error:o,currentSemesterId:a,hasLoadedSelectableCourses:t,hasLoadedEnrollments:d}=L(r=>r.courses),{currentSemester:m}=L(r=>r.timetable),[j,p]=x.useState(!1),[w,b]=x.useState(""),[k,g]=x.useState("success"),[S,P]=x.useState("");x.useEffect(()=>{m&&m.semesterId!==a&&s(G(m.semesterId))},[s,m,a]),x.useEffect(()=>{a?(!t&&!l&&s(J(a)),!d&&!l&&s(K(a))):!m&&!l&&console.warn("CourseSelectionPage: Current semester info is not available to fetch courses.")},[s,a,t,d,l]);const W=async r=>{try{const n=await s(Q(r)).unwrap();b(n.message||"选课成功！"),g("success")}catch(n){b(`选课失败: ${n||"未知错误"}`),g("error")}finally{p(!0)}},B=async(r,n)=>{try{const f=await s(q({enrollmentId:r,scheduleId:n})).unwrap();b(f.message||"退课成功！"),g("success")}catch(f){b(`退课失败: ${f||"未知错误"}`),g("error")}finally{p(!0)}},T=(r,n)=>{n!=="clickaway"&&(p(!1),o&&k==="error"&&s(_()))},H=x.useMemo(()=>{const r=new Map;return u.forEach(n=>{n.status==="enrolled"&&n.scheduleId&&r.set(n.scheduleId,n)}),r},[u]),F=x.useMemo(()=>{if(!S)return i;const r=S.toLowerCase();return i.filter(n=>{var f,E,$;return((f=n.courseName)==null?void 0:f.toLowerCase().includes(r))||((E=n.courseCode)==null?void 0:E.toLowerCase().includes(r))||(($=n.teacherName)==null?void 0:$.toLowerCase().includes(r))})},[i,S]),R=()=>{const r=l&&(!t||!d);return!a&&!m&&!l?e.jsx(y,{severity:"warning",sx:{mt:2},children:"无法获取当前学期信息，选课功能暂不可用。"}):r?e.jsxs(A,{sx:{display:"flex",justifyContent:"center",my:5},children:[e.jsx(N,{}),e.jsx(v,{sx:{ml:2},children:"加载课程数据中..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{fullWidth:!0,variant:"outlined",placeholder:"搜索课程名称、代码或教师...",value:S,onChange:n=>P(n.target.value),sx:{my:2},InputProps:{startAdornment:e.jsxs(le,{position:"start",children:[" ",e.jsx(U,{})," "]})}}),o&&!h.size&&!j&&e.jsx(y,{severity:"error",sx:{mb:2},children:o}),(t||i.length>0)&&(d||u.length>0)&&e.jsx(he,{courses:F,enrollmentsMap:H,onEnroll:W,onWithdraw:B,processingActions:h}),t&&i.length===0&&!l&&e.jsx(y,{severity:"info",sx:{mt:2},children:"当前学期没有可选课程。"})]})};return e.jsxs(D,{sx:{p:{xs:1,sm:2,md:3},minHeight:"70vh"},children:[e.jsxs(v,{variant:"h4",component:"h1",gutterBottom:!0,children:["选课中心 ",m?`(${m.semesterName})`:""]}),R(),e.jsx(ae,{open:j,autoHideDuration:4e3,onClose:T,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(y,{onClose:T,severity:k,sx:{width:"100%"},variant:"filled",children:w})})]})};export{Te as default};
