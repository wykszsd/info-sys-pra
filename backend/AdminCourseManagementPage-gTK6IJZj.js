import{r as l,j as e,M as O,d as q,C as X,u as Z,c as ee,an as re,P as se,B as _,T as te,at as ae,au as oe,av as ie,aw as ne,ax as le}from"./index-CKLgkD1v.js";import{A as ce,D as de,z as ue,C as me,E as pe,a as he}from"./ConfirmDialog-COXuYVOi.js";import{S as xe}from"./Search-HBhVGKX6.js";import{u as fe,C,s as ye,z as f}from"./index-Bf-gyStQ.js";import{D as ge,a as Ce,b as je}from"./DialogContent-DRqBLQZ-.js";import{D as be}from"./DialogTitle-CHEgnswe.js";import{G as h}from"./Grid-CW7wBfPk.js";import{T as j,F as ve}from"./TextField-CAILEkKj.js";import{F as Se,I as Ne,S as we}from"./Select-JmEIo2-X.js";import{A as M}from"./Alert-DDDj34Iz.js";import{I as Ae}from"./InputAdornment-vymAwCB7.js";import{S as Ie}from"./Snackbar-HS5EKS66.js";import"./index-BIM5zmIj.js";import"./toPropertyKey-BRA8pAMC.js";import"./typeof-QjJsDpFa.js";import"./FormControlLabel-Yt6LKP0L.js";import"./Chip-DfvBT8qY.js";import"./KeyboardArrowRight-BSJIH089.js";import"./TableCell-BtnOls6d.js";const qe=f.object({courseCode:f.string().min(3,"课程代码至少3位").max(20,"课程代码过长"),courseName:f.string().min(2,"课程名称至少2位").max(100,"课程名称过长"),credit:f.coerce.number({invalid_type_error:"学分必须是数字"}).int("学分必须是整数").min(0,"学分不能为负").max(15,"学分数值过大"),semester:f.enum(["spring","fall"],{required_error:"请选择开课学期"}),year:f.coerce.number({invalid_type_error:"年份必须是数字"}).int("年份必须是整数").min(2020,"年份过早").max(new Date().getFullYear()+5,"年份过远"),maxCapacity:f.coerce.number({invalid_type_error:"容量必须是数字"}).int("容量必须是整数").min(1,"最大容量至少为1").max(500,"容量过大").default(50),prerequisitesDisplay:f.string().default("")}),x={courseCode:"",courseName:"",credit:0,semester:"spring",year:new Date().getFullYear(),maxCapacity:50,prerequisitesDisplay:""},ze=({open:c,onClose:S,onSubmit:b,initialData:o,isSubmitting:d,apiError:i})=>{var w;const v=!!o,{control:m,handleSubmit:P,reset:y,formState:{errors:a},setError:p}=fe({resolver:ye(qe),defaultValues:x});l.useEffect(()=>{if(c)if(v&&o){let t="";try{const r=o.prerequisites;if(r&&typeof r=="string"){const u=JSON.parse(r);Array.isArray(u)&&(t=u.join(", "))}else Array.isArray(r)&&(t=r.join(", "))}catch(r){console.error("解析 initialData.prerequisites 时出错:",o.prerequisites,r)}y({courseCode:o.courseCode??x.courseCode,courseName:o.courseName??x.courseName,credit:o.credit??x.credit,semester:o.semester??x.semester,year:o.year??x.year,maxCapacity:o.maxCapacity??x.maxCapacity,prerequisitesDisplay:t||x.prerequisitesDisplay})}else y(x)},[o,c,y,v]),l.useEffect(()=>{if(i){const t=i;let r=!1;typeof i=="string"&&(i.toLowerCase().includes("code")||i.toLowerCase().includes("代码")?(p("courseCode",{type:"server",message:i}),r=!0):(i.toLowerCase().includes("name")||i.toLowerCase().includes("名称"))&&(p("courseName",{type:"server",message:i}),r=!0)),r||p("root.serverError",{type:"server",message:(t==null?void 0:t.message)||i||"发生未知错误"})}},[i,p]);const N=P(async t=>{const r=t.prerequisitesDisplay.split(",").map(g=>g.trim()).filter(Boolean),u=r.length>0?JSON.stringify(r):void 0,k={courseCode:t.courseCode,courseName:t.courseName,credit:t.credit,semester:t.semester,year:t.year,maxCapacity:t.maxCapacity,prerequisites:u};await b(k)});return e.jsxs(ge,{open:c,onClose:S,maxWidth:"sm",fullWidth:!0,PaperProps:{component:"form",onSubmit:N,noValidate:!0},children:[e.jsx(be,{children:v?"编辑课程":"新增课程"}),e.jsx(Ce,{children:e.jsxs(h,{container:!0,spacing:2,sx:{mt:.5},children:[e.jsx(h,{size:{xs:12,sm:6},children:e.jsx(C,{name:"courseCode",control:m,render:({field:t})=>{var r;return e.jsx(j,{...t,label:"课程代码",fullWidth:!0,required:!0,error:!!a.courseCode,helperText:(r=a.courseCode)==null?void 0:r.message,disabled:d})}})}),e.jsx(h,{size:{xs:12,sm:6},children:e.jsx(C,{name:"courseName",control:m,render:({field:t})=>{var r;return e.jsx(j,{...t,label:"课程名称",fullWidth:!0,required:!0,error:!!a.courseName,helperText:(r=a.courseName)==null?void 0:r.message,disabled:d})}})}),e.jsx(h,{size:{xs:12,sm:6},children:e.jsx(C,{name:"credit",control:m,render:({field:t})=>{var r;return e.jsx(j,{...t,type:"number",label:"学分",fullWidth:!0,required:!0,error:!!a.credit,helperText:(r=a.credit)==null?void 0:r.message,disabled:d,InputLabelProps:{shrink:!0}})}})}),e.jsx(h,{size:{xs:12,sm:6},children:e.jsx(C,{name:"maxCapacity",control:m,render:({field:t})=>{var r;return e.jsx(j,{...t,type:"number",label:"最大选课人数",fullWidth:!0,required:!0,error:!!a.maxCapacity,helperText:(r=a.maxCapacity)==null?void 0:r.message,disabled:d,InputLabelProps:{shrink:!0}})}})}),e.jsx(h,{size:{xs:12,sm:6},children:e.jsx(C,{name:"semester",control:m,render:({field:t})=>e.jsxs(Se,{fullWidth:!0,required:!0,error:!!a.semester,disabled:d,children:[e.jsx(Ne,{children:"开课学期"}),e.jsxs(we,{...t,label:"开课学期",children:[e.jsx(O,{value:"spring",children:"春季"}),e.jsx(O,{value:"fall",children:"秋季"})]}),a.semester&&e.jsx(ve,{children:a.semester.message})]})})}),e.jsx(h,{size:{xs:12,sm:6},children:e.jsx(C,{name:"year",control:m,render:({field:t})=>{var r;return e.jsx(j,{...t,type:"number",label:"开课年份",fullWidth:!0,required:!0,error:!!a.year,helperText:(r=a.year)==null?void 0:r.message,disabled:d,InputLabelProps:{shrink:!0}})}})}),e.jsx(h,{size:{xs:12},children:e.jsx(C,{name:"prerequisitesDisplay",control:m,render:({field:t})=>{var r;return e.jsx(j,{...t,label:"先修课程代码 (可选, 逗号分隔)",fullWidth:!0,error:!!a.prerequisitesDisplay,helperText:((r=a.prerequisitesDisplay)==null?void 0:r.message)||"例如: CS101, MA100",disabled:d})}})}),((w=a.root)==null?void 0:w.serverError)&&e.jsx(h,{size:{xs:12},children:e.jsx(M,{severity:"error",children:a.root.serverError.message})})]})}),e.jsxs(je,{sx:{px:3,pb:2},children:[e.jsx(q,{onClick:S,disabled:d,color:"inherit",children:"取消"}),e.jsx(q,{type:"submit",variant:"contained",disabled:d,children:d?e.jsx(X,{size:24,color:"inherit"}):v?"更新课程":"创建课程"})]})]})},Ke=()=>{const c=Z(),{courses:S,isLoading:b,error:o,totalCount:d,page:i,pageSize:v,filterName:m}=ee(s=>s.adminCourses),[P,y]=l.useState(!1),[a,p]=l.useState(null),[T,N]=l.useState(!1),[w,t]=l.useState(null),[r,u]=l.useState({open:!1,message:"",severity:"info"}),[k,g]=l.useState(null),[A,G]=l.useState({page:i,pageSize:v}),[I,$]=l.useState([]),[z,E]=l.useState(m||""),D=l.useCallback(s=>{const n=setTimeout(()=>{c(re(s))},500);return()=>clearTimeout(n)},[c]);l.useEffect(()=>{const s=I.length>0?`${I[0].field},${I[0].sort}`:void 0,n=z?{courseName_like:z}:void 0;D({page:A.page,pageSize:A.pageSize,sort:s,filter:n})},[A.page,A.pageSize,I,z,c,D]);const B=()=>{p(null),g(null),y(!0)},J=s=>{p(s),g(null),y(!0)},H=s=>{const n=S.find(F=>F.courseId===s);t(s),p(n||null),N(!0)},R=async()=>{if(w!==null)try{await c(le(w)).unwrap(),u({open:!0,message:"课程删除成功",severity:"success"})}catch(s){u({open:!0,message:`删除失败: ${(s==null?void 0:s.message)||s||"未知错误"}`,severity:"error"})}finally{N(!1),t(null)}},W=()=>{y(!1),p(null),g(null)},V=async s=>{g(null);try{a?(await c(ie({id:a.courseId,payload:s})).unwrap(),u({open:!0,message:"课程更新成功",severity:"success"})):(await c(ne(s)).unwrap(),u({open:!0,message:"课程创建成功",severity:"success"})),W()}catch(n){const F=(n==null?void 0:n.message)||n||(a?"更新":"创建")+"课程时发生未知错误";u({open:!0,message:F,severity:"error"}),g(F)}},Y=s=>{G(s),c(ae(s.page)),c(oe(s.pageSize))},K=s=>$(s),L=()=>u({...r,open:!1}),Q=s=>{E(s.target.value)},U=[{field:"courseId",headerName:"ID",width:90},{field:"courseCode",headerName:"课程代码",width:130},{field:"courseName",headerName:"课程名称",width:250,flex:1},{field:"credit",headerName:"学分",type:"number",width:90,align:"center",headerAlign:"center"},{field:"semester",headerName:"默认学期",width:100,valueGetter:s=>s==="spring"?"春季":"秋季"},{field:"year",headerName:"默认年份",type:"number",width:100},{field:"maxCapacity",headerName:"容量",type:"number",width:90,align:"center",headerAlign:"center"},{field:"prerequisites",headerName:"先修课程",width:200,valueGetter:s=>{try{const n=JSON.parse(s||"[]");return Array.isArray(n)?n.join(", "):""}catch{return""}}},{field:"actions",headerName:"操作",type:"actions",width:150,getActions:({row:s})=>[e.jsx(q,{size:"small",startIcon:e.jsx(pe,{}),onClick:()=>J(s),children:"编辑"},`edit-${s.courseId}`),e.jsx(q,{size:"small",startIcon:e.jsx(he,{}),color:"error",onClick:()=>H(s.courseId),children:"删除"},`delete-${s.courseId}`)]}];return e.jsxs(se,{sx:{p:2,height:"calc(100vh - 64px - 48px - 32px)",display:"flex",flexDirection:"column"},children:[" ",e.jsxs(_,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,flexWrap:"wrap",gap:2},children:[e.jsx(te,{variant:"h5",component:"h1",children:"课程管理"}),e.jsx(j,{size:"small",variant:"outlined",placeholder:"按名称或代码搜索...",value:z,onChange:Q,InputProps:{startAdornment:e.jsxs(Ae,{position:"start",children:[" ",e.jsx(xe,{})," "]})},sx:{width:{xs:"100%",sm:300}}}),e.jsx(q,{variant:"contained",startIcon:e.jsx(ce,{}),onClick:B,children:"新增课程"})]}),o&&!b&&e.jsx(M,{severity:"error",sx:{mb:2},children:o}),e.jsx(_,{sx:{flexGrow:1,width:"100%"},children:e.jsx(de,{rows:S,columns:U,rowCount:d,loading:b,pageSizeOptions:[10,25,50,100],paginationModel:A,paginationMode:"server",onPaginationModelChange:Y,sortingMode:"server",sortModel:I,onSortModelChange:K,getRowId:s=>s.courseId,localeText:ue.components.MuiDataGrid.defaultProps.localeText,disableRowSelectionOnClick:!0})}),e.jsx(ze,{open:P,onClose:W,onSubmit:V,initialData:a,isSubmitting:b,apiError:k}),e.jsx(me,{open:T,onClose:()=>N(!1),onConfirm:R,title:"确认删除课程",contentText:`您确定要删除课程 "${(a==null?void 0:a.courseName)||""}" (代码: ${a==null?void 0:a.courseCode}) 吗？此操作无法撤销，并可能影响已有的排课信息。`,isConfirming:b}),e.jsx(Ie,{open:r.open,autoHideDuration:5e3,onClose:L,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(M,{onClose:L,severity:r.severity,sx:{width:"100%"},variant:"filled",children:r.message})})]})};export{Ke as default};
