import{u as J,c as P,r as u,p as F,m as d,n as R,o as te,j as e,B as z,q as I,t as O,M as L,d as q,C as M,v as $,w as se,x as le,y as ae,e as w,P as K,z as ne,A as re,f as ie,D as oe,E as ce,T as C}from"./index-CKLgkD1v.js";import{f as N}from"./timetableUtils-zizOuD1G.js";import{G as b}from"./Grid-CW7wBfPk.js";import{D as G}from"./DatePicker-B2zoPjm4.js";import{F as k,I as Q,S as _,O as de}from"./Select-JmEIo2-X.js";import{C as T}from"./Chip-DfvBT8qY.js";import{F as E,T as me}from"./TextField-CAILEkKj.js";import{T as xe,a as he,b as ue,c as V,d as pe}from"./TableRow-DM6qFwiW.js";import{T as h}from"./TableCell-BtnOls6d.js";import{A as Y}from"./Alert-DDDj34Iz.js";import"./index-BIM5zmIj.js";import"./InputAdornment-vymAwCB7.js";import"./DialogContent-DRqBLQZ-.js";const je=48,ge=8,fe={PaperProps:{style:{maxHeight:je*4.5+ge,width:250}}},be=({buildings:o,allTimetableSections:i,isLoadingSearch:p})=>{var A;const n=J(),a=P(t=>t.classrooms.query),[l,j]=u.useState(a.startDate?F(a.startDate):d(new Date)),[r,g]=u.useState(a.endDate?F(a.endDate):R(d(new Date),6)),[c,m]=u.useState(a.sectionIds||[]),[y,S]=u.useState(a.building||""),[D,f]=u.useState(((A=a.minCapacity)==null?void 0:A.toString())||""),[x,H]=u.useState(null);u.useEffect(()=>{const{valid:t,error:s}=te(l,r,7);H(t?null:s??"日期范围无效")},[l,r]);const U=t=>{const{target:{value:s}}=t;m(typeof s=="string"?s.split(",").map(Number):s)},X=t=>{t.preventDefault();let s=!1;if(x&&(s=!0),c.length===0&&(s=!0),(!l||!r)&&(s=!0),s)return;const v={startDate:$(l),endDate:$(r),sectionIds:c,building:y||void 0,minCapacity:D?parseInt(D,10):void 0};n(se(v)),n(le(v))},Z=()=>{const t=d(new Date);j(t),g(R(t,6)),m([]),S(""),f(""),H(null),n(ae())},W=i.map(t=>({value:t.sectionId,label:`第 ${t.sectionId} 节 (${N(t.startTime)}-${N(t.endTime)})`}));return e.jsx(z,{component:"form",onSubmit:X,noValidate:!0,sx:{mb:3},children:e.jsxs(b,{container:!0,spacing:2,alignItems:"flex-start",children:[e.jsx(b,{size:{xs:12,sm:6,md:3},children:e.jsx(G,{label:"开始日期",value:l,onChange:t=>j(t?d(t):null),minDate:d(new Date),slotProps:{textField:{fullWidth:!0,size:"small",error:!!(x&&l&&I(l,d(new Date))),helperText:x&&l&&I(l,d(new Date))?x:" "}}})}),e.jsx(b,{size:{xs:12,sm:6,md:3},children:e.jsx(G,{label:"结束日期",value:r,onChange:t=>g(t?d(t):null),minDate:l||d(new Date),slotProps:{textField:{fullWidth:!0,size:"small",error:!!(x&&r&&l&&(I(r,l)||O(r,l)>=7)),helperText:x&&r&&l&&(I(r,l)||O(r,l)>=7)?x:" "}}})}),e.jsx(b,{size:{xs:12,sm:6,md:3},children:e.jsxs(k,{fullWidth:!0,size:"small",error:c.length===0&&!!a.startDate,children:[e.jsx(Q,{id:"section-select-label",children:"选择节次 *"}),e.jsx(_,{labelId:"section-select-label",multiple:!0,value:c,onChange:U,input:e.jsx(de,{label:"选择节次 *"}),renderValue:t=>e.jsx(z,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:[...t].sort((s,v)=>s-v).map(s=>{var B;const v=((B=W.find(ee=>ee.value===s))==null?void 0:B.label.split("(")[0].trim())||`第${s}节`;return e.jsx(T,{label:v,size:"small"},s)})}),MenuProps:fe,children:W.map(t=>e.jsx(L,{value:t.value,children:t.label},t.value))}),c.length===0&&!!a.startDate&&e.jsx(E,{error:!0,children:"请至少选择一个节次"}),!(c.length===0&&a.startDate)&&e.jsx(E,{children:" "})]})}),e.jsx(b,{size:{xs:12,sm:6,md:3},children:e.jsxs(k,{fullWidth:!0,size:"small",children:[e.jsx(Q,{id:"building-select-label",children:"教学楼 (可选)"}),e.jsxs(_,{labelId:"building-select-label",value:y,label:"教学楼 (可选)",onChange:t=>S(t.target.value),children:[e.jsx(L,{value:"",children:e.jsx("em",{children:"全部教学楼"})}),o.map(t=>e.jsx(L,{value:t,children:t},t))]}),e.jsx(E,{children:" "})]})}),e.jsx(b,{size:{xs:12,sm:6,md:3},children:e.jsx(me,{fullWidth:!0,size:"small",label:"最小容量 (可选)",type:"number",value:D,onChange:t=>{const s=t.target.value;s===""||/^[1-9]\d*$/.test(s)||s==="0"&&s.length===1?f(s):s.length===0&&f("")},inputProps:{min:1},helperText:" "})}),e.jsxs(b,{size:{xs:12,sm:6,md:3},sx:{display:"flex",gap:1,alignItems:"flex-end",pt:{xs:2,sm:"20px"}},children:[e.jsx(q,{type:"submit",variant:"contained",disabled:p||!!x||c.length===0||!l||!r,startIcon:p?e.jsx(M,{size:20,color:"inherit"}):null,children:"查询"}),e.jsx(q,{type:"button",variant:"outlined",onClick:Z,disabled:p,children:"清空"})]})]})})},De=w(e.jsx("path",{d:"M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2zM4 6h16v10H4z"})),ve=w(e.jsx("path",{d:"M19.8 18.4 14 10.67V6.5l1.35-1.69c.26-.33.03-.81-.39-.81H9.04c-.42 0-.65.48-.39.81L10 6.5v4.17L4.2 18.4c-.49.66-.02 1.6.8 1.6h14c.82 0 1.29-.94.8-1.6"})),ye=w(e.jsx("path",{d:"M11 18h2v-2h-2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8m0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4"})),Se=o=>{switch(o){case"multimedia":return{icon:e.jsx(De,{fontSize:"small"}),label:"多媒体"};case"lab":return{icon:e.jsx(ve,{fontSize:"small"}),label:"实验室"};case"basic":return{icon:e.jsx(ye,{fontSize:"small"}),label:"基础设备"};default:return{icon:void 0,label:String(o)}}},Ce=({results:o})=>!o||o.length===0?null:e.jsx(xe,{component:K,elevation:3,sx:{mt:2},children:e.jsxs(he,{sx:{minWidth:650},"aria-label":"空教室查询结果",children:[e.jsx(ue,{sx:{backgroundColor:"grey.100"},children:e.jsxs(V,{children:[e.jsx(h,{sx:{fontWeight:"bold"},children:"教学楼"}),e.jsx(h,{sx:{fontWeight:"bold"},children:"教室号"}),e.jsx(h,{align:"right",sx:{fontWeight:"bold"},children:"容量"}),e.jsx(h,{sx:{fontWeight:"bold"},children:"设备类型"})]})}),e.jsx(pe,{children:o.map(i=>{const{icon:p,label:n}=Se(i.equipment);return e.jsxs(V,{hover:!0,sx:{"&:last-child td, &:last-child th":{border:0}},children:[e.jsx(h,{component:"th",scope:"row",children:i.building}),e.jsx(h,{children:e.jsx(T,{icon:e.jsx(ne,{}),label:i.roomNumber,variant:"outlined",size:"small"})}),e.jsx(h,{align:"right",children:e.jsx(T,{icon:e.jsx(re,{}),label:typeof i.capacity=="number"?i.capacity.toString():"N/A",size:"small"})}),e.jsx(h,{children:e.jsx(ie,{title:n,children:e.jsx(T,{icon:p,label:n,size:"small",variant:"outlined"})})})]},i.classroomId)})})]})}),Re=()=>{const o=J(),{availableClassrooms:i,buildings:p,isLoading:n,error:a,query:l,hasLoadedBuildings:j}=P(f=>f.classrooms),{allSections:r,isLoadingSections:g,error:c,hasLoadedAllSections:m}=P(f=>f.timetable);u.useEffect(()=>{!j&&!n&&o(oe()),!m&&!g&&o(ce())},[o,j,n,m,g]);const y=!j&&n||!m&&g,S=a||(!m&&!g&&c?`节次数据: ${c}`:null),D=j&&m;return e.jsxs(K,{sx:{p:{xs:1,sm:2,md:3},minHeight:"70vh"},children:[e.jsx(C,{variant:"h4",component:"h1",gutterBottom:!0,children:"空教室查询"}),y&&e.jsxs(z,{sx:{display:"flex",justifyContent:"center",alignItems:"center",my:3},children:[e.jsx(M,{})," ",e.jsx(C,{sx:{ml:2},children:"加载查询选项..."})]}),!y&&!D&&S&&e.jsxs(Y,{severity:"warning",sx:{mt:2},children:["无法加载查询表单所需数据: ",S]}),D&&e.jsx(be,{buildings:p,allTimetableSections:r,isLoadingSearch:n}),n&&l.startDate&&e.jsxs(z,{sx:{display:"flex",justifyContent:"center",my:3},children:[e.jsx(M,{})," ",e.jsx(C,{sx:{ml:2},children:"正在查询空教室..."})]}),a&&!n&&l.startDate&&e.jsx(Y,{severity:a.startsWith("没有找到")?"info":"error",sx:{mt:2},children:a}),!n&&!a&&i.length>0&&e.jsx(Ce,{results:i}),!n&&!a&&i.length===0&&l.startDate&&e.jsx(C,{sx:{mt:2,textAlign:"center",color:"text.secondary"},children:"没有找到符合当前查询条件的空教室。"}),!l.startDate&&!n&&i.length===0&&e.jsx(C,{sx:{mt:2,textAlign:"center",color:"text.secondary"},children:"请选择查询条件开始搜索。"})]})};export{Re as default};
