import{r as I,j as e,B as D,T as O,M as v,d as H,C as R,m as y,p as ee,R as re,h as se,u as oe,c as F,V as ae,U as te,E as de,W as ne,X as P,P as ie,Y as le,Z as ce}from"./index-CKLgkD1v.js";import{S as ue,E as me}from"./EventAvailable-D8fnVWep.js";import{u as G,C as x,s as U,z as m}from"./index-Bf-gyStQ.js";import{W as pe}from"./WeekPicker-CSi71gVf.js";import{G as l}from"./Grid-CW7wBfPk.js";import{A as T}from"./FormControlLabel-Yt6LKP0L.js";import{T as f,F as C}from"./TextField-CAILEkKj.js";import{F as q,I as k,S as W}from"./Select-JmEIo2-X.js";import{D as he}from"./DatePicker-B2zoPjm4.js";import{T as xe,a as B}from"./Tabs-Cdd7RlJK.js";import{A as M}from"./Alert-DDDj34Iz.js";import{S as je}from"./Snackbar-HS5EKS66.js";import"./InfoOutlined-CEViPEnt.js";import"./timetableUtils-zizOuD1G.js";import"./Chip-DfvBT8qY.js";import"./index-BIM5zmIj.js";import"./InputAdornment-vymAwCB7.js";import"./DialogContent-DRqBLQZ-.js";import"./KeyboardArrowRight-BSJIH089.js";const be=m.object({originalScheduleId:m.number({required_error:"请选择要调课的原始课程"}).positive("请选择要调课的原始课程"),proposedSectionId:m.number({required_error:"请选择新节次"}).positive("请选择新节次"),proposedWeekDay:m.number({required_error:"请选择新星期"}).min(1,"星期无效").max(7,"星期无效"),proposedWeeks:m.string().min(1,"请选择或输入新周次").regex(/^((\d{1,2}(-\d{1,2})?)(,\s*\d{1,2}(-\d{1,2})?)*)$|^(\d{1,2})$/,"周次格式不正确 (e.g., 1-8,10 或 5)"),proposedClassroomId:m.number({required_error:"请选择新教室"}).positive("请选择新教室"),reason:m.string().min(5,"调课原因至少5个字符").max(500,"原因过长")}),ge=a=>{if(!a)return"";const p=["一","二","三","四","五","六","日"],u=a.weekDay&&a.weekDay>=1&&a.weekDay<=7?`周${p[a.weekDay-1]}`:"日期未知",h=a.sectionId?`第${a.sectionId}节`:"节次未知",d=a.classroomBuilding&&a.classroomRoomNumber?`(${a.classroomBuilding}${a.classroomRoomNumber})`:"(地点未知)",c=a.weeks?`[周次: ${a.weeks}]`:"[周次未知]";return`${a.courseName||"未知课程"} (${a.courseCode||"N/A"}) - ${u} ${h} ${d} ${c}`},Ie=({teacherSchedules:a,allTimetableSections:p,allClassroomsList:u,onSubmitRequest:h,isSubmitting:d,initialData:c})=>{const{control:i,handleSubmit:S,reset:j,setValue:t,formState:{errors:n}}=G({resolver:U(be),defaultValues:c||{originalScheduleId:void 0,proposedSectionId:void 0,proposedWeekDay:void 0,proposedWeeks:"",proposedClassroomId:void 0,reason:""}});I.useEffect(()=>{j(c||{originalScheduleId:void 0,proposedSectionId:void 0,proposedWeekDay:void 0,proposedWeeks:"",proposedClassroomId:void 0,reason:""})},[c,j]);const b=async o=>{const r={...o};await h(r)};return e.jsx(D,{component:"form",onSubmit:S(b),noValidate:!0,sx:{mt:1},children:e.jsxs(l,{container:!0,spacing:2.5,children:[e.jsxs(l,{size:{xs:12},children:[" ",e.jsx(x,{name:"originalScheduleId",control:i,render:({field:o})=>e.jsx(T,{options:a,getOptionLabel:ge,value:a.find(r=>r.scheduleId===o.value)||null,onChange:(r,s)=>{o.onChange(s==null?void 0:s.scheduleId),s?(t("proposedSectionId",s.sectionId,{shouldValidate:!0}),t("proposedWeekDay",s.weekDay,{shouldValidate:!0}),t("proposedWeeks",s.weeks||"",{shouldValidate:!0}),t("proposedClassroomId",s.classroomId,{shouldValidate:!0})):(t("proposedSectionId",void 0,{shouldValidate:!0}),t("proposedWeekDay",void 0,{shouldValidate:!0}),t("proposedWeeks","",{shouldValidate:!0}),t("proposedClassroomId",void 0,{shouldValidate:!0}))},isOptionEqualToValue:(r,s)=>r.scheduleId===s.scheduleId,renderInput:r=>{var s;return e.jsx(f,{...r,label:"选择要调课的原始课程安排",required:!0,error:!!n.originalScheduleId,helperText:(s=n.originalScheduleId)==null?void 0:s.message})},disabled:d||a.length===0})}),a.length===0&&!d&&e.jsx(C,{sx:{ml:1},children:"您的课程安排加载中或暂无安排..."})]}),e.jsx(l,{size:{xs:12},sx:{mt:2,mb:1},children:e.jsx(O,{variant:"subtitle1",fontWeight:"medium",gutterBottom:!0,children:"申请调整为："})}),e.jsx(l,{size:{xs:12,sm:6,md:4},children:e.jsx(x,{name:"proposedSectionId",control:i,render:({field:o})=>e.jsxs(q,{fullWidth:!0,required:!0,error:!!n.proposedSectionId,size:"small",disabled:d,children:[e.jsx(k,{id:"proposedSectionId-change-label",children:"新节次"}),e.jsxs(W,{labelId:"proposedSectionId-change-label",...o,value:o.value===void 0?"":o.value,label:"新节次",onChange:r=>{const s=r.target.value;typeof s=="string"&&s===""?o.onChange(void 0):o.onChange(Number(s))},children:[e.jsx(v,{value:"",children:e.jsx("em",{children:"请选择节次"})}),p.map(r=>e.jsx(v,{value:r.sectionId,children:`第${r.sectionId}节 (${r.startTime.substring(0,5)}-${r.endTime.substring(0,5)})`},r.sectionId))]}),n.proposedSectionId&&e.jsx(C,{error:!0,children:n.proposedSectionId.message})]})})}),e.jsx(l,{size:{xs:12,sm:6,md:4},children:e.jsx(x,{name:"proposedWeekDay",control:i,render:({field:o})=>e.jsxs(q,{fullWidth:!0,required:!0,error:!!n.proposedWeekDay,size:"small",disabled:d,children:[e.jsx(k,{id:"proposedWeekDay-change-label",children:"新星期"}),e.jsxs(W,{labelId:"proposedWeekDay-change-label",...o,value:o.value===void 0?"":o.value,label:"新星期",onChange:r=>{const s=r.target.value;typeof s=="string"&&s===""?o.onChange(void 0):o.onChange(Number(s))},children:[e.jsx(v,{value:"",children:e.jsx("em",{children:"请选择星期"})}),[1,2,3,4,5,6,7].map(r=>e.jsx(v,{value:r,children:`周${["一","二","三","四","五","六","日"][r-1]}`},r))]}),n.proposedWeekDay&&e.jsx(C,{error:!0,children:n.proposedWeekDay.message})]})})}),e.jsx(l,{size:{xs:12,sm:6,md:4},children:e.jsx(x,{name:"proposedClassroomId",control:i,render:({field:o})=>e.jsx(T,{options:u,getOptionLabel:r=>`${r.building} ${r.roomNumber} (容:${r.capacity})`,value:u.find(r=>r.classroomId===o.value)||null,onChange:(r,s)=>o.onChange(s==null?void 0:s.classroomId),isOptionEqualToValue:(r,s)=>r.classroomId===s.classroomId,renderInput:r=>{var s;return e.jsx(f,{...r,label:"新教室",required:!0,error:!!n.proposedClassroomId,helperText:((s=n.proposedClassroomId)==null?void 0:s.message)||(u.length===0?"教室列表加载中...":""),size:"small"})},disabled:d||u.length===0})})}),e.jsx(l,{size:{xs:12},children:e.jsx(x,{name:"proposedWeeks",control:i,render:({field:o})=>{var r;return e.jsx(pe,{value:o.value,onChange:s=>o.onChange(s),label:"新教学周次 *",error:!!n.proposedWeeks,helperText:(r=n.proposedWeeks)==null?void 0:r.message,disabled:d})}})}),e.jsx(l,{size:{xs:12},children:e.jsx(x,{name:"reason",control:i,render:({field:o})=>{var r;return e.jsx(f,{...o,label:"调课原因",fullWidth:!0,required:!0,multiline:!0,rows:3,error:!!n.reason,helperText:(r=n.reason)==null?void 0:r.message,disabled:d})}})}),e.jsx(l,{size:{xs:12},sx:{textAlign:"right",mt:2},children:e.jsx(H,{type:"submit",variant:"contained",disabled:d,startIcon:d?e.jsx(R,{size:20,color:"inherit"}):null,children:"提交调课申请"})})]})})},ve=m.object({courseId:m.number({required_error:"请选择课程"}),examType:m.enum(["midterm","final","makeup"],{required_error:"请选择考试类型"}),proposedDate:m.date({required_error:"请选择考试日期"}).min(y(new Date),"考试日期不能早于今天"),proposedSectionId:m.number({required_error:"请选择考试节次"}),proposedClassroomId:m.number({required_error:"请选择考场"}),proposedDuration:m.coerce.number().int().min(30,"考试时长至少30分钟").max(240,"考试时长过长"),reason:m.string().min(5,"申请原因至少5个字符").max(500)}),Se=({teacherSchedules:a,allTimetableSections:p,allClassroomsList:u,onSubmitRequest:h,isSubmitting:d,initialData:c})=>{const{control:i,handleSubmit:S,reset:j,formState:{errors:t}}=G({resolver:U(ve),defaultValues:c||{courseId:void 0,examType:"final",proposedDate:y(new Date),proposedSectionId:void 0,proposedClassroomId:void 0,proposedDuration:120,reason:""}});I.useEffect(()=>{j(c?{...c,proposedDate:c.proposedDate?ee(c.proposedDate):y(new Date)}:{courseId:void 0,examType:"final",proposedDate:y(new Date),proposedSectionId:void 0,proposedClassroomId:void 0,proposedDuration:120,reason:""})},[c,j]);const n=re.useMemo(()=>{const o=new Map;return a.forEach(r=>{r.courseId&&!o.has(r.courseId)&&o.set(r.courseId,{courseId:r.courseId,courseName:r.courseName||`课程ID ${r.courseId}`,courseCode:r.courseCode||"N/A"})}),Array.from(o.values())},[a]),b=async o=>{const r={...o,proposedDate:se(o.proposedDate)};await h(r)};return e.jsx(D,{component:"form",onSubmit:S(b),noValidate:!0,children:e.jsxs(l,{container:!0,spacing:3,children:[e.jsxs(l,{size:{xs:12,sm:6},children:[" ",e.jsx(x,{name:"courseId",control:i,render:({field:o})=>e.jsx(T,{options:n,getOptionLabel:r=>`${r.courseCode} - ${r.courseName}`,value:n.find(r=>r.courseId===o.value)||null,onChange:(r,s)=>o.onChange(s==null?void 0:s.courseId),isOptionEqualToValue:(r,s)=>r.courseId===s.courseId,renderInput:r=>{var s;return e.jsx(f,{...r,label:"选择课程",required:!0,error:!!t.courseId,helperText:(s=t.courseId)==null?void 0:s.message})},disabled:d||n.length===0})}),n.length===0&&e.jsx(C,{children:"您的课程安排加载中或暂无课程..."})]}),e.jsxs(l,{size:{xs:12,sm:6},children:[" ",e.jsx(x,{name:"examType",control:i,render:({field:o})=>e.jsxs(q,{fullWidth:!0,required:!0,error:!!t.examType,size:"small",children:[e.jsx(k,{children:"考试类型"}),e.jsxs(W,{...o,value:o.value??"",label:"考试类型",children:[e.jsx(v,{value:"midterm",children:"期中"}),e.jsx(v,{value:"final",children:"期末"}),e.jsx(v,{value:"makeup",children:"补考"})]}),t.examType&&e.jsx(C,{error:!0,children:t.examType.message})]})})]}),e.jsxs(l,{size:{xs:12,sm:6,md:4},children:[" ",e.jsx(x,{name:"proposedDate",control:i,render:({field:o})=>{var r;return e.jsx(he,{...o,label:"建议考试日期",minDate:y(new Date),slotProps:{textField:{fullWidth:!0,required:!0,error:!!t.proposedDate,helperText:(r=t.proposedDate)==null?void 0:r.message,size:"small"}}})}})]}),e.jsxs(l,{size:{xs:12,sm:6,md:4},children:[" ",e.jsx(x,{name:"proposedSectionId",control:i,render:({field:o})=>e.jsxs(q,{fullWidth:!0,required:!0,error:!!t.proposedSectionId,size:"small",children:[e.jsx(k,{children:"建议考试节次"}),e.jsxs(W,{...o,value:o.value??"",onChange:r=>{const s=r.target.value;typeof s=="string"&&s===""?o.onChange(void 0):o.onChange(Number(s))},label:"建议考试节次",children:[e.jsx(v,{value:"",children:e.jsx("em",{children:"请选择节次"})})," ",p.map(r=>e.jsx(v,{value:r.sectionId,children:`第${r.sectionId}节 (${r.startTime.substring(0,5)}-${r.endTime.substring(0,5)})`},r.sectionId))]}),t.proposedSectionId&&e.jsx(C,{error:!0,children:t.proposedSectionId.message})]})})]}),e.jsxs(l,{size:{xs:12,sm:6,md:4},children:[" ",e.jsx(x,{name:"proposedClassroomId",control:i,render:({field:o})=>e.jsx(T,{options:u,getOptionLabel:r=>`${r.building} ${r.roomNumber} (容:${r.capacity})`,value:u.find(r=>r.classroomId===o.value)||null,onChange:(r,s)=>o.onChange(s==null?void 0:s.classroomId),isOptionEqualToValue:(r,s)=>r.classroomId===s.classroomId,renderInput:r=>{var s;return e.jsx(f,{...r,label:"建议考场",required:!0,error:!!t.proposedClassroomId,helperText:((s=t.proposedClassroomId)==null?void 0:s.message)||(u.length===0?"教室加载中...":""),size:"small"})},disabled:d||u.length===0})})]}),e.jsxs(l,{size:{xs:12,sm:6},children:[" ",e.jsx(x,{name:"proposedDuration",control:i,render:({field:o})=>{var r;return e.jsx(f,{...o,label:"建议时长 (分钟)",type:"number",fullWidth:!0,required:!0,error:!!t.proposedDuration,helperText:(r=t.proposedDuration)==null?void 0:r.message,size:"small"})}})]}),e.jsxs(l,{size:{xs:12},children:[" ",e.jsx(x,{name:"reason",control:i,render:({field:o})=>{var r;return e.jsx(f,{...o,label:"申请原因/备注",fullWidth:!0,required:!0,multiline:!0,rows:3,error:!!t.reason,helperText:(r=t.reason)==null?void 0:r.message,disabled:d})}})]}),e.jsxs(l,{size:{xs:12},sx:{textAlign:"right"},children:[" ",e.jsx(H,{type:"submit",variant:"contained",disabled:d,startIcon:d?e.jsx(R,{size:20,color:"inherit"}):null,children:"提交考试安排申请"})]})]})})};function w(a){const{children:p,value:u,index:h,...d}=a;return e.jsx("div",{role:"tabpanel",hidden:u!==h,id:`request-tabpanel-${h}`,"aria-labelledby":`request-tab-${h}`,...d,children:u===h&&e.jsx(D,{sx:{pt:3},children:p})})}const Be=()=>{const a=oe(),[p,u]=I.useState(0),{teacherSchedules:h,isLoadingSchedules:d,isSubmittingChange:c,isSubmittingExam:i,submitSuccess:S,error:j,currentSemesterIdForSchedules:t,hasLoadedTeacherSchedules:n}=F(g=>g.requests),{currentSemester:b,allSections:o,isLoadingSections:r,hasLoadedAllSections:s}=F(g=>g.timetable),{allClassroomsShort:_,isLoading:$,hasLoadedClassroomsShort:z}=F(g=>g.sharedData),[X,E]=I.useState(!1),[Y,L]=I.useState("");I.useEffect(()=>{b&&b.semesterId!==t&&a(ae(b.semesterId))},[a,b,t]),I.useEffect(()=>{t&&!n&&!d&&a(te(t)),!s&&!r&&a(de()),!z&&!$.classrooms&&a(ne())},[a,t,n,d,s,r,z,$.classrooms]),I.useEffect(()=>{S&&(L(p===0?"调课申请已成功提交！":"考试安排申请已成功提交！"),E(!0),a(P()))},[S,p,a]),I.useEffect(()=>{j&&c===!1&&i===!1&&(L(`提交失败: ${j}`),E(!0))},[j,c,i,a]);const Z=(g,V)=>{u(V),a(P())},J=async g=>{await a(le(g)).unwrap()},K=async g=>{await a(ce(g)).unwrap()},N=()=>E(!1),Q=d||r||$.classrooms,A=n&&s&&z;return e.jsxs(ie,{sx:{p:{xs:2,sm:3},minHeight:"70vh"},children:[e.jsx(O,{variant:"h4",component:"h1",gutterBottom:!0,children:"提交申请"}),e.jsx(D,{sx:{borderBottom:1,borderColor:"divider",mb:2},children:e.jsxs(xe,{value:p,onChange:Z,"aria-label":"申请类型",variant:"fullWidth",children:[e.jsx(B,{label:"调课申请",icon:e.jsx(ue,{}),iconPosition:"start",id:"request-tab-0","aria-controls":"request-tabpanel-0"}),e.jsx(B,{label:"考试安排申请",icon:e.jsx(me,{}),iconPosition:"start",id:"request-tab-1","aria-controls":"request-tabpanel-1"})]})}),Q&&!A&&e.jsxs(D,{sx:{display:"flex",justifyContent:"center",my:3},children:[e.jsx(R,{}),e.jsx(O,{sx:{ml:2},children:"加载表单数据..."})]}),A&&!b&&e.jsx(M,{severity:"warning",children:"无法获取当前学期信息，申请功能暂不可用。"}),A&&b&&e.jsxs(e.Fragment,{children:[e.jsx(w,{value:p,index:0,children:e.jsx(Ie,{teacherSchedules:h,allTimetableSections:o,allClassroomsList:_,onSubmitRequest:J,isSubmitting:c})}),e.jsx(w,{value:p,index:1,children:e.jsx(Se,{teacherSchedules:h,allTimetableSections:o,allClassroomsList:_,onSubmitRequest:K,isSubmitting:i})})]}),e.jsx(je,{open:X,autoHideDuration:5e3,onClose:N,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(M,{onClose:N,severity:S?"success":"error",sx:{width:"100%"},variant:"filled",children:Y})})]})};export{Be as default};
